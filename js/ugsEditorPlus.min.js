/**
 * This library implments the UkeGeeks Scriptasaurus Song-a-matic editor functions, bridging the page UI and scriptasaurus methods.
 * @module  ugsEditorPlus
 * @namespace  ugsEditorPlus
 * @class ugsEditorPlus
 */
var ugsEditorPlus = (function() {
	/**
	 * attach public members to this object
	 * @property _public
	 * @type JsonObject
	 */
	var _public = {};

	/**
	 * attaches event handlers, preps variables, and runs UGS
	 * @method init
	 * @private
	 * @param isLegacyIe {bool} pre-IE 9 versions
	 */
	var init = function(isLegacyIe) {
		// ukeGeeks.tumblr.opts.diagramResizeTo = 1;
		ukeGeeks.settings.opts.retainBrackets = false;

		ukeGeeks.scriptasaurus.init(isLegacyIe);

		ugsEditorPlus.actions.init(isLegacyIe);
		ugsEditorPlus.topMenus.init();
		ugsEditorPlus.submenuUi.init(ugsEditorPlus.actions.doAction);
		ugsEditorPlus.optionsDlg.init(ugsEditorPlus.actions.doAction);
		ugsEditorPlus.chordBuilder.init();
		ugsEditorPlus.actions.run();
	};

	/**
	 * wraps the private Init method for modern browsers
	 * @method attach
	 * @public
	 */
	_public.attach = function() {
		init(false);
	};

	/**
	 * wraps the private Init method, required for Legacy Internet Exploere (pre-9)
	 * @method attach
	 * @public
	 */
	_public.attachIe = function() {
		init(true);
	};

	// ---------------------------------------
	// return public interface "JSON handle"
	// ---------------------------------------
	return _public;

}());
;ugsEditorPlus.actions=function(){var b={},c={},a=null,d=null,f=[],g=/^([A-G][#b]?)(m|m6|7|m7|dim|maj7|6|sus2|sus4|aug|9)?$/,n={placement:"above",transpose:"up_0"};b.init=function(a){c={songText:document.getElementById("ukeSongText"),songContainer:document.getElementById("ukeSongContainer"),cpmSource:document.getElementById("chordProSource"),scalableArea:document.getElementById("scalablePrintArea")}};b.doAction=function(a,m){switch(a){case "zoomFonts":var k=parseFloat(m,10);c.scalableArea.style.fontSize=
k+"pt";break;case "zoomDiagrams":var k=parseInt(m,10)/100,h=Math.round(225*k),e=ugsEditorPlus.styles.getSheet("ugsEditorCss"),l=e.Find(".scalablePrintArea .ugs-diagrams-wrap canvas");l.style.width=Math.round(k*ukeGeeks.settings.fretBox.width)+"px";l.style.height=Math.round(k*ukeGeeks.settings.fretBox.height)+"px";l=e.Find(".scalablePrintArea .ugs-diagrams-wrap");l.style.width=h+"px";l=e.Find(".scalablePrintArea .ugs-source-wrap");l.style.marginLeft=25+h+"px";break;case "layout":$("body").toggleClass("diagramsOnTop",
"top"==m).toggleClass("diagramsOnSide","left"==m).toggleClass("ugsHideDiagrams","none"==m);break;case "placement":ukeGeeks.toolsLite.setClass(c.songContainer,"ugsInline","inline"==m);(k="miniDiagrams"==m)||ukeGeeks.toolsLite.removeClass(c.songContainer,"ugsInlineDiagrams");k||"miniDiagrams"==n.placement?(ukeGeeks.settings.inlineDiagrams=k,b.run()):k||"miniDiagrams"==n.placement||ukeGeeks.overlapFixer.Fix(c.songText);n.placement=m;break;case "tuning":k=ukeGeeks.definitions.instrument.sopranoUke;h=
"Standard <strong>GCEA</strong> Soprano Ukulele";"baritone"==m&&(k=ukeGeeks.definitions.instrument.baritoneUke,h="Standard <strong>DGBE</strong> Baritone Ukulele");$("#footTuningInfo").html(h);ukeGeeks.scriptasaurus.setTuningOffset(k);b.run();break;case "colors":ugsEditorPlus.themes.set(m);b.run();break;case "transpose":k="u"==m[0]?1:-1;h=parseInt(m[m.length-1],10);e=k*h;k=[];l="";for(h=0;h<f.length;h++)g.test(f[h])?k.push(f[h]):l+=f[h]+", ";if(!(0<l.length)||confirm("Sorry, but some of your chords can't be transposed:\n"+
l+"\n\nDo you want to continue anyway?")){for(var e=ukeGeeks.transpose.shiftChords(k,e),l=d,p,h=0;h<k.length;h++)p=RegExp("\\["+k[h]+"\\]","g"),l=l.replace(p,"[ugsxx_"+h+"]");for(h=0;h<e.length;h++)p=RegExp("\\[ugsxx_"+h+"\\]","g"),l=l.replace(p,"["+e[h]+"]");c.cpmSource.value=l;b.run()}break;case "paper":k=["letter","a4","screen"];h=$("body");for(e=0;e<k.length;e++)h.removeClass("pageWidth_"+k[e]);h.addClass("pageWidth_"+m);break;case "showEnclosures":ukeGeeks.settings.opts.retainBrackets=m;b.run();
break;case "hideCommonChords":ukeGeeks.settings.opts.ignoreCommonChords=m;b.run();break;case "setCommonChords":k=m.split(/[ ,]+/);h=[];for(e=0;e<k.length;e++)l=ukeGeeks.toolsLite.trim(k[e]),0<l.length&&h.push(l);ukeGeeks.settings.commonChords=h;ukeGeeks.settings.opts.ignoreCommonChords&&b.run();break;case "update":b.run(!0);break;default:console.log("Unrecognized "+a+" > "+m)}};b.run=function(b){b=0<arguments.length&&b;c.songText.innerHTML="<pre>"+c.cpmSource.value+"</pre>";a=ukeGeeks.scriptasaurus.run();
1>a.chords.length&&ugsEditorPlus.autoReformat.run(c);if(a&&(ugsEditorPlus.songUi.update(a),b||null===d)){d=c.cpmSource.value;f=a.chords;var m=1>a.chords.length?"":a.chords[0],k=document.getElementById("transposeOptions").getElementsByTagName("li"),h,e=-6;n.transpose="up_0";ugsEditorPlus.submenuUi.resetTransposeLabel();for(i=0;i<k.length;i++)ukeGeeks.toolsLite.removeClass(k[i],"checked"),h=1>m.length?"":ukeGeeks.transpose.shift(m,e),k[i].getElementsByTagName("em")[0].innerHTML=h,0===e&&ukeGeeks.toolsLite.addClass(k[i],
"checked"),e++}};return b}();
ugsEditorPlus.songUi=function(){var b={},c=function(a,c){var b=c&&0<c.length,g=document.getElementById(a);g&&(g.innerHTML=b?c:"",g.style.display=b?"block":"none")};b.update=function(a){var b=document.getElementById("songTitle");b.innerHTML=0<a.title.length?a.title:"Untitled-Song";c("songArtist",a.artist);c("songAlbum",a.album);c("songSubtitle",a.st);b=document.getElementById("songMeta");if(!a.ugsMeta||1>a.ugsMeta.length)b.style.display="none";else{for(var f="",g=0;g<a.ugsMeta.length;g++)f+="<p>"+
a.ugsMeta[g]+"</p>";b.innerHTML=f;b.style.display="block"}};return b}();
ugsEditorPlus.styles=new function(){var b=null;this.Rules=null;this.getSheet=function(c){a:{for(var a=0;a<document.styleSheets.length;a++)if(document.styleSheets[a].title==c){b=document.styleSheets[a];break a}b=null}c=null==b?[]:b.cssRules?b.cssRules:b.rules;this.Rules=c;return this};this.Find=function(b){b=b.toLowerCase();for(var a=0;a<this.Rules.length;a++)if(this.Rules[a].selectorText&&this.Rules[a].selectorText.toLowerCase()==b)return this.Rules[a];return null}};
ugsEditorPlus.themes=new function(){var b={normal:{name:"Normal (white paper)",selectText:"Normal colors (white paper)",description:"Simple, legible text on white paper",song:{fretLines:"#003366",dots:"#ff0000",dotText:"#ffffff",text:"#000000",fretText:"#4a4a4a"},tabs:{lines:"#999999",dots:"#eaeaea",text:"#000000"}},reversed:{name:"Reversed for projectors",selectText:"Reversed colors (for projectors)",description:"Light text on dark background",song:{fretLines:"#365F70",dots:"#FDD96F",dotText:"#000000",
text:"#FF6040",fretText:"#999999"},tabs:{lines:"#365F70",dots:"#FDD96F",text:"#000000"}},frosty:{name:"Frostcicle",selectText:"Frostcicle (cool blue)",description:"Brrrr... icy cool blues",song:{fretLines:"#66B4CC",dots:"#332335",dotText:"#9FE1F9",text:"#0896FE",fretText:"#E3D8BA"},tabs:{lines:"#6699FF",dots:"#EFFCF9",text:"#00558E"}},jellyBean:{name:"Jelly Beans",selectText:"Jelly Beans (vibrant)",description:"Sugary, vibrant bowl of jelly beans!",song:{fretLines:"#49BC45",dots:"#FF9417",dotText:"#FCF49F",
text:"#D20070",fretText:"#4a4a4a"},tabs:{lines:"#6699FF",dots:"#FFF9BA",text:"#75003E"}},justBlack:{name:"Just Black",selectText:"Black (for laser printers)",description:"No color, but black, best for B&W laser printers",song:{fretLines:"#cccccc",dots:"#000000",dotText:"#ffffff",text:"#000000",fretText:"#000000"},tabs:{lines:"#cccccc",dots:"#000000",text:"#ffffff"}},krampus:{name:"Gruss vom Krampus",selectText:"Krampus (Ye Olde Christmas)",description:"Seasons Greetin's, Happy Holidays, Merry Christmas, Krampus Nichte!",
song:{fretLines:"#929867",dots:"#A22C27",dotText:"#EBD592",text:"#4F2621",fretText:"#4a4a4a"},tabs:{lines:"#B69C01",dots:"#E1EEC8",text:"#75003E"}},western:{name:"Out West",selectText:"Out West (dust country)",description:"Dusty Honky Tonk/Country/Western look",song:{fretLines:"#B5A679",dots:"#CF8300",dotText:"#ffffff",text:"#386571",fretText:"#4a4a4a"},tabs:{lines:"#697665",dots:"#F1E3C5",text:"#632424"}},pumpkin:{name:"Pumpkin Pie",selectText:"Pumpkin Pie (fall colors)",description:"Fall 'n Halloween 'n Jack o'Lantern 'n Thanksgiving Fun",
song:{fretLines:"#8E9A6C",dots:"#DA6328",dotText:"#FFEE4A",text:"#68391D",fretText:"#B14623"},tabs:{lines:"#BED379",dots:"#FFF4D8",text:"#B14623"}},notebook:{name:"Rock Notebook",selectText:"Rock Notebook (marker)",description:"A strong, hand-scrawled, and edgily unreliable look",song:{fretLines:"#747CAD",dots:"#1C0866",dotText:"#ffffff",text:"#B22000",fretText:"#A4A0B2"},tabs:{lines:"#A4A0B2",dots:"#F1E3C5",text:"#2E2ECC"}},zombie:{name:"Zombies!!!",selectText:"Zombies!!!",description:"Blood 'n gore for Halloween",
song:{fretLines:"#9EB036",dots:"#E52501",dotText:"#FEDA79",text:"#798666",fretText:"#B14623"},tabs:{lines:"#602749",dots:"#F7F9EA",text:"#4F5F3E"}}};this.getDescription=function(c){return b[c].selectText};this.loadList=function(c){var a="",d;for(d in b)b.hasOwnProperty(d)&&(a+='<li class="'+("normal"==d?"checked":"")+'"><a href="#'+d+'" title="'+b[d].description+'">'+b[d].name+"</a></li>");$(c).html(a)};this.set=function(c){var a=$("body"),d;for(d in b)b.hasOwnProperty(d)&&a.removeClass("theme-"+
d);a.addClass("theme-"+c);c=b[c];ukeGeeks.settings.colors=c.song;ukeGeeks.settings.tabs.lineColor=c.tabs.lines;ukeGeeks.settings.tabs.dotColor=c.tabs.dots;ukeGeeks.settings.tabs.textColor=c.tabs.text}};
ugsEditorPlus.optionsDlg=function(){var b={},c=null,a,d,f;b.init=function(b){c=b;a=document.getElementById("commonChordList");d=document.getElementById("chkIgnoreCommon");f=document.getElementById("chkEnclosures");a.value=ukeGeeks.settings.commonChords.join(", ");d.checked=ukeGeeks.settings.opts.ignoreCommonChords;f.checked=!ukeGeeks.settings.opts.retainBrackets;document.getElementById("updateBtn").onclick=function(){c("update",null);return!1};f.onclick=function(){c("showEnclosures",!this.checked)};
a.onchange=function(){c("setCommonChords",a.value)};d.onclick=function(){c("hideCommonChords",this.checked)};$(".checkboxBlock label, input[type=checkbox]").click(function(a){a.stopPropagation()});$(".overlay").draggable({handle:"hgroup"})};return b}();var ugsEditorPlus=window.ugsEditorPlus||{};
ugsEditorPlus.reformat=new function(){var b=!1,c=function(){this.source="";this.spaceCount=this.wordCount=0;this.words=[];this.lineType=this.chordCount=0},a=/\b(\S+)\b/gi,d=/(\s+)/g,f=/(^\s+)/,g=/\b[A-G][#b]?(m|m6|m7|m9|dim|dim7|maj7|sus2|sus4|aug|6|7|9|add9|7sus4)?\b/,n=/\b(\S+\s*)/g,s=/^\s*(\|{0,2}[A-Gb]?\|{0,2}[-x0-9|:]{4,})/;this.run=function(m){b=!1;var k=[];m=m.replace("\t","    ");m=m.split("\n");for(var h=0;h<m.length;h++){var e=m[h].match(a),l=new c;l.source=m[h];if(null!=e&&0<e.length){l.wordCount=
e.length;l.words=e;for(var p=l,q=0,r=0;r<e.length;r++)e[r].match(g)&&q++;p.chordCount=q}p=m[h].match(d);null!=p&&0<p.length&&(l.spaceCount=p.length);p=l;e=l;1>e.spaceCount+e.wordCount?e=0:null!=e.source.match(s)?e=3:(q=2,0<e.chordCount&&e.wordCount==e.chordCount&&(q=1,b=!0),e=q);p.lineType=e;k.push(l)}h="";for(m=0;m<k.length;)if(l=k[m],p=k[m+1],m++,p&&0!=l.lineType){if(e=3==l.lineType)a:if(m+3>=k.length)e=!1;else{for(e=m;e<m+3;e++)if(3!=k[e].lineType){e=!1;break a}e=!0}if(e)h+="{start_of_tab}\n"+
l.source.replace(f,"")+"\n"+p.source.replace(f,"")+"\n"+k[m+1].source.replace(f,"")+"\n"+k[m+2].source.replace(f,"")+"\n{end_of_tab}\n",m+=3;else if(1!=l.lineType||2!=p.lineType){if(1==l.lineType){l=l.source.replace(d," ").split(" ");p="";for(e=0;e<l.length;e++)0<l[e].length&&(p+="["+l[e]+"] ");l=p+"\n"}else l=l.source+"\n";h+=l}else{m++;q=l.source;for(l=p.source;l.length<q.length;)l+=" ";p="";e=q.match(n);r=q.match(f);q=0;r&&(p+=l.substr(q,r[0].length),q=r[0].length);for(r=0;r<e.length;r++)p+="["+
e[r].replace(d,"")+"]"+l.substr(q,e[r].length),q+=e[r].length;q<l.length&&(p+=l.substr(q,l.length));h+=p+"\n"}}else h+=l.source+"\n";return h};this.hasChords=function(){return b}};
ugsEditorPlus.autoReformat=function(){var b={},c={},a,d=!1;b.run=function(b){d||(c=b,c.reformatTextBox=document.getElementById("reformatSource"),c.reformatDlg=document.getElementById("reformatDlg"),document.getElementById("reformatYesBtn").onclick=function(){c.cpmSource.value=a;f();ugsEditorPlus.actions.run(!0);return!1},document.getElementById("reformatNoBtn").onclick=function(){f();return!1},b=document.getElementById("reformatDisable"),b.checked=!1,b.onclick=function(){d=this.checked},a=ugsEditorPlus.reformat.run(c.cpmSource.value),
c.reformatTextBox.innerHTML=a,ugsEditorPlus.reformat.hasChords()&&ukeGeeks.toolsLite.removeClass(c.reformatDlg,"isHidden"))};var f=function(){ukeGeeks.toolsLite.addClass(c.reformatDlg,"isHidden")};return b}();
ugsEditorPlus.topMenus=function(){var b={init:function(){$("#ugsAppToolbar > ul li").not("[data-dialog]").children("a").click(c);$(".showOptionsBox a").click(n);$("#ugsAppToolbar > ul li[data-dialog]").click(d);$(".closeBtn").click(f);$(".resizeBtn").click(g)}},c=function(){var b=$(this).parent(),c=b.hasClass("active");a();c||b.addClass("active")},a=function(){$("#ugsAppToolbar > ul > li").removeClass("active")},d=function(a){a=$(this).data("dialog");$("#"+a).fadeIn();return!1},f=function(a){$(this).parents(".overlay").fadeOut();
return!1},g=function(a){a=$(this).parents(".overlay");ugsEditorPlus.resize.toggle(a);return!1},n=function(a){a=$(this).attr("href");$(".arrowBox").not(a).hide();a=$(a);a.find("dd").hide();a.fadeToggle();ugsEditorPlus.submenuUi.reset(a);return!1};b.makeAllInactive=a;return b}();
ugsEditorPlus.submenuUi=function(){var b={},c=null,a=null;b.init=function(b){a=b;ugsEditorPlus.themes.loadList("#colorPicker .pseudoSelect");$(".enablePseudoSelects label").click(f);$(".pseudoSelect li").click(d);$("body").bind("click",s);$(".arrowBox").click(n)};var d=function(b){b=$(this);var e;e=b.children().attr("href");e="#"==e[0]?e.substr(1):e;var m=b.parents("dd"),d=m.attr("id"),m=m.data("action");$("#"+d).hide().find("li").removeClass("checked");b.addClass("checked");g(this,!1);c=null;$("label[for="+
d+"] span").text(k(m,e,b));$("label[for="+d+"]").parents("dt").removeClass("active");a(m,e);return!1},f=function(a){a=$(this);var b=a.attr("for");a.closest("dl").children("dt").removeClass("active");a.closest("dt").addClass("active");$("#"+b).show();g(this,!0);null!=c&&$("#"+c.id).hide();c=null!=c&&c.id==b?null:{id:b};return!1};b.reset=function(a){a.find("dt").removeClass("active");a.find(".event-userSelecting").removeClass("event-userSelecting")};var g=function(a,b){$(a).parents(".enablePseudoSelects").toggleClass("event-userSelecting",
b)},n=function(a){if(!$(a.target).is("a"))return $(this).find("dd").hide(),c=null,!1},s=function(a){$(".arrowBox").fadeOut(270);ugsEditorPlus.topMenus.makeAllInactive()},m={zoomDiagrams:["Tiny","Small","Medium","Large","Stupid Large"],layout:["Reference diagrams on left","Reference diagrams at top","No reference diagrams"],placement:["Chord names inline with lyrics","Chord names above lyrics","Names & diagrams above lyrics"],tuning:["Soprano (GCEA) tuning","Baritone (DBEA) tuning"]},k=function(a,
b,k){var c=k.index();switch(a){case "paper":return"Width "+k.text();case "zoomFonts":return"Font size "+b+"pt";case "zoomDiagrams":return m.zoomDiagrams[c]+" diagrams";case "colors":return ugsEditorPlus.themes.getDescription(b);case "transpose":return"up_0"==b?"Original key":k.text().replace(" ",' steps - "')+'"';default:return m[a][c]}};b.resetTransposeLabel=function(){$("label[for=transposePicker] span").text("Original key")};return b}();
ugsEditorPlus.newSong=function(){var b={},c=!1,a="";b.init=function(b){a=b;$("#newSongBtn").click(function(a){a=$("#songTitle");var b=a.val().trim();a.val(b);a=2<b.length;f(!a,"Song's title is required<br/><em>(you may change it later, must be at least 2 characters)</em>");a&&d()});$("#openNewDlgBtn").click(function(a){$("#songTitle, #songArtist").val("");$("#newSongForm").fadeIn();$("#songTitle").focus()});$("#hideNewSongBtn").click(g);$("#newSongForm").bind("keydown",n);$spinner=$("#loadingSpinner");
$spinner.hide();$(document).ajaxStart(function(){$spinner.show();c=!0}).ajaxStop(function(){$spinner.hide();c=!1})};var d=function(){if(!c){var b={handler:"ugs_new",songTitle:$("#songTitle").val(),songArtist:$("#songArtist").val()};$.ajax({url:a,type:"POST",dataType:"json",data:JSON.stringify(b),success:function(a){f(a.HasErrors,a.Message);a.HasErrors||(document.location.href=a.ContinueUri)}})}},f=function(a,b){var c=$("#newSongForm .errorMessage");a?(c.show().html(b),$("#songTitle").focus()):c.hide()},
g=function(a){$("#newSongForm").fadeOut()},n=function(a){27==a.which&&g()};return b}();
ugsEditorPlus.updateSong=function(){var b={},c="",a="",d=!1;b.init=function(b,n){c=b;a=n;$("#saveBtn").click(function(a){f();return!1});$("#messageBox").hide();$(document).ajaxStart(function(){$("#sourceFeedback").hide().html();$("#messageBox").slideDown("fast");$("#loadingSpinner").show();d=!0}).ajaxStop(function(){$("#messageBox").delay(3E3).fadeOut("slow");d=!1})};var f=function(){if(!d){$("#sourceFeedback").show();var b={handler:"ugs_update_81jr",filename:a,song:$("#chordProSource").val()};$.ajax({url:c,
type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(b),success:function(a){a=a.Message;$("#loadingSpinner").hide();$("#sourceFeedback").show().html(a)}})}};return b}();
ugsEditorPlus.typeahead=function(){var b={},c=[],a={},d="",f,g=[],n=/\s{2,}/g,s=/([^a-z0-9]+)/gi,m=/['`\u2019-]/g,k=function(){$("li").each(function(b){var k=$(this);b=h(k.text());b=b.toLowerCase();var e=k.children("a").attr("href"),d=e.toLowerCase(),k=k.children("a").html(),k=k.replace('<strong class="','<span class="bigger ').replace("</strong>","</span>");a[d]={html:k,searchText:b,code:d,href:e};c.push(d)})},h=function(a){return a.toLowerCase().replace(m,"").replace(s," ").replace(n," ").trim()},
e=function(a,b){d=h(a);g=d.split(" ");for(var k="",e=0;e<g.length;e++)g[e]=g[e].trim(),0<g[e].length&&(k+=(0<k.length?"|":"")+g[e]);f=RegExp("("+k+")","gi");b(c)},l=function(b){window.location=a[b].href;return a[b].searchText},p=function(b){b=a[b];for(var k=0;k<g.length;k++)if(-1==b.searchText.indexOf(g[k]))return!1;return!0},q=function(b){return b.sort(function(b,k){return a[b].searchText>a[k].searchText})},r=function(b){b=$("<div/>").html(a[b].html);$("em, .bigger",b).each(function(a){a=$(this);
var b=a.html();a.html(b.replace(f,"<strong>$1</strong>"))});return b.html()};b.initialize=function(){k();$("#quickSearch").typeahead({source:e,updater:l,matcher:p,sorter:q,highlighter:r,minLength:2,items:50}).val("").focus()};return b};
ugsEditorPlus.resize=function(){var b={},c,a,d=!1;b.toggle=function(b){c=$(window);a=$(b);d=!0==a.data("sized");a.data("sized",d);if(d)a.css({left:"auto"}).animate({right:10,width:450},800);else{b=c.width();c.height();var g=a.position();a.css({left:g.left+"px"}).animate({left:10,right:10,top:45,width:b-30},800)}a.data("sized",!d)};return b}();
ugsEditorPlus.chordBuilder=function(){var b={},c=null;b.init=function(){var b=$(".fingerToolImage").css("background-image");ugsChordBuilder.settings.cursor.imageUri=b.replace(/url\("(.*)hand.png"\)/i,"$1hand-cursor.png");c=new ugsChordBuilder.editorUi;c.init();$("#cdBldOpenBtn").click(a)};var a=function(a){a.preventDefault();c.reload();a=$(this).data("dialog");$("#"+a).fadeIn()};return b}();var ugsChordBuilder=window.ugsChordBuilder||{};
ugsChordBuilder.entities={BoundingBox:function(b,c){this.x=b?b.x:0;this.y=b?b.y:0;this.width=c?c.width:1;this.height=c?c.height:1},Dot:function(b,c,a){this.string=b;this.fret=c?c:0;this.finger=a?a:0},Position:function(b,c){this.x=b?b:0;this.y=c?c:0}};
ugsChordBuilder.settings=function(){var b=ugsChordBuilder.entities,c={x:75,y:75},a={numFrets:5,maxFret:16,stringNames:["G","C","E","A"],strokeWidth:4,strokeColor:"#8F8569",fretSpace:35,stringSpace:30},d=function(){return{height:a.fretSpace,width:a.stringSpace}};return{anchorPos:c,cursor:{fillColor:"rgba(220, 216, 73, 0.35)",strokeWidth:1,strokeColor:"#AAB444",radius:9,imageUri:"/img/editor/hand-cursor.png"},fretBoard:a,dot:{fillColor:"#F68014",radius:11,strokeWidth:2,strokeColor:"#D56333",fontWeight:"bold",
fontFamily:'Arial, "Helvetica Neue", Helvetica, Verdana, sans-serif',fontSize:16,fontColor:"#ffffff"},fretLabel:{fontFamily:'Arial, "Helvetica Neue", Helvetica, Verdana, sans-serif',fontSize:28,color:"#6A6A63",lightColor:"#EAEAE8"},stringLabel:{fontFamily:'Arial, "Helvetica Neue", Helvetica, Verdana, sans-serif',fontSize:34,color:"#DCD849"},chord:{nameMaxLength:20},targetDimensions:d,targetAnchorPos:function(){var f=d();return new b.Position(c.x-0.5*f.width,c.y-f.height-0.2*a.strokeWidth)},centerAnchor:function(b){c.x=
0.5*b.width-0.5*(a.stringNames.length-1)*a.stringSpace-a.strokeWidth;c.y=0.5*b.height-0.5*a.numFrets*a.stringSpace}}}();
ugsChordBuilder.tracking=new function(){var b=ugsChordBuilder.entities,c=ugsChordBuilder.settings,a=null;this.toDot=function(d){var f=new b.BoundingBox(d),g;a||(g=c.targetDimensions(),g.width*=c.fretBoard.stringNames.length,g.height*=c.fretBoard.numFrets+1,a=new b.BoundingBox(c.targetAnchorPos(),g));g=a;if(!(f.x<g.x+g.width&&f.x+f.width>g.x&&f.y<g.y+g.height&&f.y+f.height>g.y))return null;f=c.targetDimensions();return new b.Dot(Math.floor((d.x-g.x)/f.width),Math.floor((d.y-g.y)/f.height))}};
ugsChordBuilder.fretDots=new function(){var b=ugsChordBuilder.entities,c=ugsChordBuilder.settings.anchorPos,a=ugsChordBuilder.settings.fretBoard,d=ugsChordBuilder.settings.dot,f=[];this.getDots=function(){return f.slice()};this.slide=function(b){var c;a:{for(c=0;c<f.length;c++)if(1>f[c].fret+b||f[c].fret+b>a.numFrets){c=!1;break a}c=!0}if(!c)return!1;for(c=0;c<f.length;c++)f[c].fret+=b;return!0};this.toggleDot=function(a){if(0==a.fret)n(a.string);else{var b=g(a);0>b?f.push(a):f.splice(b,1)}};this.toggleFinger=
function(a,b){var c=g(a);if(0>c)return!1;f[c].finger=f[c].finger==b?0:b;return!0};this.reset=function(){for(var b=0;b<a.stringNames.length;b++)n(b)};var g=function(b){for(var a=f.length-1;0<=a;a--)if(f[a].string==b.string&&f[a].fret==b.fret)return a;return-1},n=function(a){for(var b=f.length-1;0<=b;b--)f[b].string==a&&f.splice(b,1)};this.draw=function(g){for(var m=f.length-1;0<=m;m--){var k;k=f[m];k=new b.Position(c.x+0.47*a.strokeWidth+k.string*a.stringSpace,c.y+0.47*a.strokeWidth+(k.fret-0.5)*a.fretSpace);
var h=g,e=k;h.beginPath();h.arc(e.x,e.y,d.radius,0,2*Math.PI,!1);h.fillStyle=d.fillColor;h.fill();h.lineWidth=d.strokeWidth;h.strokeStyle=d.strokeColor;h.stroke();0<f[m].finger&&(h=g,e=f[m].finger,h.font=d.fontWeight+" "+d.fontSize+"px "+d.fontFamily,h.textAlign="center",h.fillStyle=d.fontColor,h.fillText(e,k.x,k.y+0.3*d.fontSize))}}};
ugsChordBuilder.cursorCanvas=new function(){var b=ugsChordBuilder.settings.cursor,c=ugsChordBuilder.settings.dot,a=null,d=null,f=!1,g=!0,n=1,s={x:0,y:0};this.init=function(b){a=b;m()};var m=function(){d=new Image;d.onload=function(){f=!0};d.src=b.imageUri};this.setCursor=function(b,a){g=b;n=a};this.draw=function(k){var h=b.radius+b.strokeWidth;a.clearRect(s.x-h,s.y-h,h+50,h+60);!f||g?(a.beginPath(),a.arc(k.x,k.y,b.radius,0,2*Math.PI,!1),a.fillStyle=b.fillColor,a.fill(),a.lineWidth=b.strokeWidth,a.strokeStyle=
b.strokeColor,a.stroke()):(a.drawImage(d,k.x,k.y),a.font=c.fontWeight+" "+c.fontSize+"px "+c.fontFamily,a.textAlign="left",a.fillStyle="black",a.fillText(n,k.x+0.8*d.width,k.y+d.height));s=k}};
ugsChordBuilder.chordCanvas=new function(){var b=ugsChordBuilder.entities,c=ugsChordBuilder.settings.centerAnchor,a=ugsChordBuilder.settings.anchorPos,d=ugsChordBuilder.settings.fretLabel,f=ugsChordBuilder.settings.stringLabel,g=ugsChordBuilder.settings.fretBoard,n=null,s=null;this.init=function(b,a){n=b;s=a;c(s)};this.draw=function(c,k){n.clearRect(0,0,s.width,s.height);for(var h=new b.Position(a.x-0.3*d.fontSize,a.y+d.fontSize),e=1<k?d.color:d.lightColor,l=0;l<g.numFrets;l++){var p=k+l,q=h;n.font=
d.fontSize+"px "+d.fontFamily;n.textAlign="right";n.fillStyle=e;n.fillText(p,q.x,q.y);h.y+=g.fretSpace;e=d.lightColor}h=new b.Position(a.x+0.5*g.strokeWidth,a.y-0.25*d.fontSize);for(l=0;l<g.stringNames.length;l++)p=g.stringNames[l],e=h,n.font=f.fontSize+"px "+f.fontFamily,n.textAlign="center",n.fillStyle=f.color,n.fillText(p,e.x,e.y),h.x+=g.stringSpace;l=g.strokeWidth/2;p=g.numFrets*g.fretSpace;e=(g.stringNames.length-1)*g.stringSpace;n.beginPath();for(h=1;h<g.stringNames.length-1;h++)q=a.x+h*g.stringSpace+
l,n.moveTo(q,a.y+l),n.lineTo(q,a.y+p+l);for(h=1;h<g.numFrets;h++)q=a.y+h*g.fretSpace+l,n.moveTo(a.x+l,q),n.lineTo(a.x+e+l,q);n.rect(a.x+l,a.y+l,e,p);n.strokeStyle=g.strokeColor;n.lineWidth=g.strokeWidth;n.stroke();n.closePath();ugsChordBuilder.fretDots.draw(n)}};
ugsChordBuilder["export"]=new function(){var b=ugsChordBuilder.settings.fretBoard,c=ugsChordBuilder.settings.chord,a=null,d=function(b,a){this.string=b;this.dots=a?a:[]},f=function(){var a,c=[];for(a=1;a<=b.stringNames.length;a++)c.push(new d(a));var e=ugsChordBuilder.fretDots.getDots();for(a=c.length-1;0<=a;a--)for(var l=e.length-1;0<=l;l--)c[a].string==e[l].string+1&&c[a].dots.push(e[l]);return c},g=function(a){for(var b=0,c=900,d=a.length-1;0<=d;d--)a[d].fret>b&&(b=a[d].fret),a[d].fret<c&&(c=a[d].fret);
return{max:b,min:900>c?c:b}},n=function(b){return 0<b?a+b:0},s=function(a,b){for(var c=0;c<a.length;c++)if(a[c].fret==b)return a[c].finger;return 0};this.getPrimaryFrets=function(b){a=b-1;b=f();for(var c=[],e=0;e<b.length;e++){var d=g(b[e].dots);c.push(n(d.max))}return c};this.getDefinition=function(b,c){var d=(b=m(b))&&0<b.length?b:"CHORDNAME",l="",p="",q="";a=c-1;for(var r=f(),t=0;t<r.length;t++){var u=g(r[t].dots),l=l+(n(u.max)+" "),p=p+(s(r[t].dots,u.max)+" ");u.max!=u.min&&(q+=" add: string "+
r[t].string+" fret "+n(u.min)+" finger "+s(r[t].dots,u.min))}return("{define: "+d+" frets "+l+" fingers "+p+q+"}").replace(/\s+/g," ").replace(" }","}")};this.getDefinitionHtml=function(b,a){b=m(b);var c=this.getDefinition(b,a),c=c.replace(" "+b," X07Myq791wso01"),c=c.replace(/\b(\d+)\b/g,'<span class="chordPro-X07MX001number">$1</span>'),c=c.replace(/\b(frets?|fingers?|string)\b/g,'<span class="chordPro-X07MX001attribute">$1</span>'),c=c.replace(/\b(define|add)\b/g,'<span class="chordPro-X07MX001keyword">$1</span>');
return c.replace("X07Myq791wso01",'<span class="chordPro-string">'+b+"</span>").replace(/X07MX001/g,"").replace(/ +/g," ")};var m=function(b){b=b.replace(/^\s*(.*?)\s*$/,"$1").replace(/\s+/g,"-");/^(frets|fingers|add:)$/i.test(b)&&(b="");return b.substring(0,c.nameMaxLength)}};
ugsChordBuilder.chooserList=new function(){var b=[],c=null,a=0,d=null,f=function(){},g=this,n=null,s={showText:!1,height:50,width:40,fretSpace:9,stringSpace:7,dotRadius:3,lineWidth:1,topLeftPos:{x:10,y:2},xWidth:0.7*7,xStroke:1.4},m={dot:"8pt Arial",text:"8pt Arial",fret:"8pt Arial"},k={fretLines:"#EED18E",dots:"#551D00",dotText:"#ffffff",text:"#000000",fretText:"#EED18E",xStroke:"#551D00"},h=function(b,c){this.id=a++;this.name=b;this.definition=c};this.init=function(b){f=b;c=document.getElementById("cdBldPick");
c.addEventListener("click",l,!1);e()};var e=function(){for(var a=/\{define:\s*([^}]+?)\s+frets[^}]+?\}/im,d=document.getElementById("chordProSource").value.split("\n"),e=d.length-1;0<=e;e--)a.test(d[e])&&z(d[e].replace(a,"$1"),d[e]);for(var d=c,e=b,f="",a=0;a<e.length;a++)f+=q(e[a].id,e[a].name);d.innerHTML='<li data-id="-1" class="newChord">+ Add New Chord</li>'+f;d=d.getElementsByTagName("li");for(a=d.length-1;0<=a;a--)1>a||r(d[a].getAttribute("data-id"))};this.reset=function(){b=[];document.getElementById("cdBldPick").innerHTML=
"";a=0;d=null;e()};this.show=function(b){document.getElementById("cdBldChooserPanel").style.display=b?"block":"none";document.getElementById("cdBldBuilderPanel").style.display=b?"none":"block";$("#cdBldChooserPanel").closest(".overlay").toggleClass("chordBuilderNarrow",b)};this.save=function(a){var e;a:{e=null==d?-1:d.id;for(var f=a.name.toLowerCase(),g=b.length-1;0<=g;g--)if(""+b[g].id!=""+e&&b[g].name.toLowerCase()==f){e=g;break a}e=-1}if(0<=e)return alert("Hey, this chord name is already being used."),
!1;e=-1;if(null==d){e=z(a.name,a.definition);d=w(e);a=a.definition;for(var f=document.getElementById("chordProSource"),g=/\s*\{\s*(title|t|artist|subtitle|st|album|define):.*?\}/im,k=f.value.split("\n"),h="",l=!1,m=k.length-1;0<=m;m--)!l&&g.test(k[m])&&(h=a+"\n"+h,l=!0),h=k[m]+"\n"+h;f.value=h;ugsEditorPlus.actions.run()}else{f=y(d.id);if(0>f)return!1;g=b[f].definition;b[f].name=a.name;b[f].definition=a.definition;e=b[f].id;u(g,b[f].definition)}a=w(e);(f=p(e))?f.innerHTML=q(e,a.name,!0):(a=a.name,
f=document.createElement("ul"),f.innerHTML=q(e,a),c.appendChild(f.childNodes[0]));r(e);this.show(!0);return!0};var l=function(a){a.preventDefault();d=w(a.target.getAttribute("data-id"));if("delete"==a.target.getAttribute("data-action")){if(a=d,confirm('Delete definition for "'+a.name+'"?')){var b=p(a.id);b&&(c.removeChild(b),u(a.definition,""))}}else{a=null;if(null!=d){a=ukeGeeks.chordImport.runLine(d.definition);a:{if(a.muted)for(b=0;b<a.muted.length;b++)if(a.muted[b]){b=!0;break a}b=!1}b&&alert("Uh-oh! This chord uses muted strings!\nCurrently the Chord Builder does not support muted strings -- \nsaving edits will result in mutes being lost.")}f(a);
g.show(!1)}},p=function(a){for(var b=c.getElementsByTagName("li"),d=0;d<b.length;d++)if(b[d].getAttribute("data-id")==""+a)return b[d];return null},q=function(a,b,c){c=2<arguments.length?c:!1;var d='<span class="deleteChord" data-id="'+a+'" data-action="delete" title="Remove this definition"></span>'+b;return c?d:'<li data-id="'+a+'" title="Edit this definition" class="ugs-grouped">'+d+"</li>"},r=function(a){var b=p(a);a=w(a);a=ukeGeeks.chordImport.runLine(a.definition);null==n&&(n=new ukeGeeks.chordBrush);
n.plot(b,a,s,m,k)},t=function(a,b,c){var d=a.replace(b,c);return d==a?a:t(d,b,c)},u=function(a,b){var c=document.getElementById("chordProSource");c.value=t(c.value,a,b);ugsEditorPlus.actions.run()},y=function(a){for(var c=0;c<b.length;c++)if(""+b[c].id==a)return c;return-1},w=function(a){a=y(a);return 0<=a?b[a]:null},z=function(a,c){var d=new h(a,c);b.push(d);return d.id}};
ugsChordBuilder.editorUi=function(){var b=null,c=null,a=null,d=1,f="",g=!0,n=0,s={0:"None",1:"Index finger",2:"Middle finger",3:"Ring finger",4:"Pinkie"};this.init=function(){b=document.getElementById("cdBldCursorCanvas");if(!b.getContext)return!1;for(var d=b.getContext("2d"),f=document.getElementById("cdBldDiagramCanvas").getContext("2d"),g=document.getElementById("cdBldStartingFret"),n="",p=ugsChordBuilder.settings.fretBoard.maxFret-ugsChordBuilder.settings.fretBoard.numFrets+1,r=1;r<=p;r++)n+=
'<option value="'+r+'">'+r+"</option>";g.innerHTML=n;g.addEventListener("change",u,!1);document.getElementById("cdBldChordName").addEventListener("keyup",t,!1);c=document.getElementById("cdBldDotsBtn");a=document.getElementById("cdBldFingersBtn");c.addEventListener("click",q,!1);a.addEventListener("click",q,!1);document.getElementById("cdBldShowOutputBtn").addEventListener("click",k,!1);document.getElementById("cdBldCancelBtn").addEventListener("click",h,!1);document.getElementById("cdBldSaveBtn").addEventListener("click",
e,!1);document.getElementById("toolboxSlideUpBtn").addEventListener("click",y,!1);document.getElementById("toolboxSlideDownBtn").addEventListener("click",y,!1);m();document.getElementById("cdBldEditorSurface").addEventListener("mousemove",w,!1);b.addEventListener("click",z,!1);ugsChordBuilder.chordCanvas.init(f,b);ugsChordBuilder.cursorCanvas.init(d);x();v();ugsChordBuilder.chooserList.init(l);return!0};var m=function(){n++;4<n&&(n=0);document.getElementById("cdBldBtnFingerName").innerHTML=s[n]+" ("+
n+")";document.getElementById("cdBldBtnDiagram").className="fingerToolImage finger"+n},k=function(a){r(document.getElementById("cdBldOutputBox"),"collapseOutput",!a.target.checked)},h=function(a){a.preventDefault();p();ugsChordBuilder.chooserList.show(!0)},e=function(a){a.preventDefault();a={name:f,startingFret:d,dots:ugsChordBuilder.fretDots.getDots(),definition:ugsChordBuilder["export"].getDefinition(f,d)};ugsChordBuilder.chooserList.save(a)||(a=document.getElementById("cdBldChordName"),a.focus(),
a.select())},l=function(a){if(null==a)p();else{var b;b=a.dots;for(var c=0,d=0;d<b.length;d++)b[d].fret>c&&(c=b[d].fret);b=c;b=b>ugsChordBuilder.settings.fretBoard.numFrets?b-ugsChordBuilder.settings.fretBoard.numFrets+1:1;c=p;d=a.name;a=a.dots;for(var e=b-1,f=[],g=0;g<a.length;g++){var h=a[g].fret-e;f.push(new ugsChordBuilder.entities.Dot(a[g].string,0>h?0:h,a[g].finger))}c(d,b,f,!1)}},p=function(b,e,h,k){k=3<arguments.length?k:!0;ugsChordBuilder.fretDots.reset();var l=k;f=b&&0<b.length?b:"CHORDNAME";
document.getElementById("cdBldChordName").value=f;d=e?e:1;document.getElementById("cdBldStartingFret").value=d;document.getElementById("cdBldShowOutputBtn").checked=!1;r(document.getElementById("cdBldOutputBox"),"collapseOutput",!0);document.getElementById("cdBldSaveBtn").value=l?"Add":"Update";g=!0;n=0;m();r(c,"selected",g);r(a,"selected",!g);r(document.getElementById("cdBldToolbox"),"open",!g);ugsChordBuilder.cursorCanvas.setCursor(g,n);if(h&&0<h.length)for(l=0;l<h.length;l++)ugsChordBuilder.fretDots.toggleDot(h[l]);
x();v()},q=function(b){b.preventDefault();b=0<=b.currentTarget.href.indexOf("#dots");b==g?b||(m(),ugsChordBuilder.cursorCanvas.setCursor(g,n)):(r(c,"selected",b),r(a,"selected",!b),r(document.getElementById("cdBldToolbox"),"open",!b),g=b,ugsChordBuilder.cursorCanvas.setCursor(g,n))},r=function(a,b,c){var d=0<=a.className.indexOf(b);c&&!d?a.className+=" "+b:!c&&d&&(a.className=a.className.replace(b,"").replace(/\s+/g," "))},t=function(a){f=this.value;v()},u=function(a){d=parseInt(this.value,10);v();
x()},y=function(a){a.preventDefault();var b=!1;a="up"==a.target.getAttribute("data-direction")?-1:1;if(ugsChordBuilder.fretDots.slide(a))b=!0;else{a=d+a;var c=ugsChordBuilder.settings.fretBoard.maxFret-ugsChordBuilder.settings.fretBoard.numFrets+1;1<=a&&a<=c&&(d=a,document.getElementById("cdBldStartingFret").value=a,b=!0)}b&&(x(),v())},w=function(a){ugsChordBuilder.cursorCanvas.draw(A(this,a))},z=function(a){a=A(b,a);var c=ugsChordBuilder.tracking.toDot(a);c&&(g?(ugsChordBuilder.fretDots.toggleDot(c),
x(a),v()):ugsChordBuilder.fretDots.toggleFinger(c,n)&&(x(a),v()))},A=function(a,b){var c=a.getBoundingClientRect();return new ugsChordBuilder.entities.Position(b.clientX-c.left,b.clientY-c.top)},x=function(a){a=a||new ugsChordBuilder.entities.Position(0,0);ugsChordBuilder.chordCanvas.draw(a,d)},v=function(){document.getElementById("cdBldOutput").innerHTML=ugsChordBuilder["export"].getDefinitionHtml(f,d)};this.reload=function(){p();ugsChordBuilder.chooserList.reset();ugsChordBuilder.chooserList.show(!0)}};