/**
 * This library implments the UkeGeeks Scriptasaurus Song-a-matic editor functions, bridging the page UI and scriptasaurus methods.
 * @module  ugsEditorPlus
 * @namespace  ugsEditorPlus
 * @class ugsEditorPlus
 */
var ugsEditorPlus = (function() {
	/**
	 * attach public members to this object
	 * @property _public
	 * @type JsonObject
	 */
	var _public = {};

	/**
	 * attaches event handlers, preps variables, and runs UGS
	 * @method init
	 * @private
	 * @param isLegacyIe {bool} pre-IE 9 versions
	 */
	var init = function(isLegacyIe) {
		// ukeGeeks.tumblr.opts.diagramResizeTo = 1;
		ukeGeeks.settings.opts.retainBrackets = false;

		ukeGeeks.scriptasaurus.init(isLegacyIe);

		ugsEditorPlus.actions.init(isLegacyIe);
		ugsEditorPlus.topMenus.init();
		ugsEditorPlus.submenuUi.init(ugsEditorPlus.actions.doAction);
		ugsEditorPlus.optionsDlg.init(ugsEditorPlus.actions.doAction);
		ugsEditorPlus.chordBuilder.init();
		ugsEditorPlus.actions.run();
	};

	/**
	 * wraps the private Init method for modern browsers
	 * @method attach
	 * @public
	 */
	_public.attach = function() {
		init(false);
	};

	/**
	 * wraps the private Init method, required for Legacy Internet Exploere (pre-9)
	 * @method attach
	 * @public
	 */
	_public.attachIe = function() {
		init(true);
	};

	// ---------------------------------------
	// return public interface "JSON handle"
	// ---------------------------------------
	return _public;

}());
;ugsEditorPlus.actions=function(){var b={},c={},a=null,e=null,f=[],k=/^([A-G][#b]?)(m|m6|7|m7|dim|maj7|6|sus2|sus4|aug|9)?$/,n={placement:"above",transpose:"up_0"};b.init=function(a){c={songText:document.getElementById("ukeSongText"),songContainer:document.getElementById("ukeSongContainer"),cpmSource:document.getElementById("chordProSource"),scalableArea:document.getElementById("scalablePrintArea")}};b.doAction=function(a,m){switch(a){case "zoomFonts":var g=parseFloat(m,10);c.scalableArea.style.fontSize=
g+"pt";break;case "zoomDiagrams":var g=parseInt(m,10)/100,h=Math.round(225*g),d=ugsEditorPlus.styles.getSheet("ugsEditorCss"),l=d.Find(".scalablePrintArea .ugs-diagrams-wrap canvas");l.style.width=Math.round(g*ukeGeeks.settings.fretBox.width)+"px";l.style.height=Math.round(g*ukeGeeks.settings.fretBox.height)+"px";l=d.Find(".scalablePrintArea .ugs-diagrams-wrap");l.style.width=h+"px";l=d.Find(".scalablePrintArea .ugs-source-wrap");l.style.marginLeft=25+h+"px";break;case "layout":$("body").toggleClass("diagramsOnTop",
"top"==m).toggleClass("diagramsOnSide","left"==m).toggleClass("ugsHideDiagrams","none"==m);break;case "placement":ukeGeeks.toolsLite.setClass(c.songContainer,"ugsInline","inline"==m);(g="miniDiagrams"==m)||ukeGeeks.toolsLite.removeClass(c.songContainer,"ugsInlineDiagrams");g||"miniDiagrams"==n.placement?(ukeGeeks.settings.inlineDiagrams=g,b.run()):g||"miniDiagrams"==n.placement||ukeGeeks.overlapFixer.Fix(c.songText);n.placement=m;break;case "tuning":g=ukeGeeks.definitions.instrument.sopranoUke;h=
"Standard <strong>GCEA</strong> Soprano Ukulele";"baritone"==m&&(g=ukeGeeks.definitions.instrument.baritoneUke,h="Standard <strong>DGBE</strong> Baritone Ukulele");$("#footTuningInfo").html(h);ukeGeeks.scriptasaurus.setTuningOffset(g);b.run();break;case "colors":ugsEditorPlus.themes.set(m);b.run();break;case "transpose":g="u"==m[0]?1:-1;h=parseInt(m[m.length-1],10);d=g*h;g=[];l="";for(h=0;h<f.length;h++)k.test(f[h])?g.push(f[h]):l+=f[h]+", ";if(!(0<l.length)||confirm("Sorry, but some of your chords can't be transposed:\n"+
l+"\n\nDo you want to continue anyway?")){for(var d=ukeGeeks.transpose.shiftChords(g,d),l=e,p,h=0;h<g.length;h++)p=RegExp("\\["+g[h]+"\\]","g"),l=l.replace(p,"[ugsxx_"+h+"]");for(h=0;h<d.length;h++)p=RegExp("\\[ugsxx_"+h+"\\]","g"),l=l.replace(p,"["+d[h]+"]");c.cpmSource.value=l;b.run()}break;case "paper":g=["letter","a4","screen"];h=$("body");for(d=0;d<g.length;d++)h.removeClass("pageWidth_"+g[d]);h.addClass("pageWidth_"+m);break;case "showEnclosures":ukeGeeks.settings.opts.retainBrackets=m;b.run();
break;case "hideCommonChords":ukeGeeks.settings.opts.ignoreCommonChords=m;b.run();break;case "setCommonChords":g=m.split(/[ ,]+/);h=[];for(d=0;d<g.length;d++)l=ukeGeeks.toolsLite.trim(g[d]),0<l.length&&h.push(l);ukeGeeks.settings.commonChords=h;ukeGeeks.settings.opts.ignoreCommonChords&&b.run();break;case "update":b.run(!0);break;default:console.log("Unrecognized "+a+" > "+m)}};b.run=function(b){b=0<arguments.length&&b;c.songText.innerHTML="<pre>"+c.cpmSource.value+"</pre>";a=ukeGeeks.scriptasaurus.run();
1>a.chords.length&&ugsEditorPlus.autoReformat.run(c);if(a&&(ugsEditorPlus.songUi.update(a),b||null===e)){e=c.cpmSource.value;f=a.chords;var m=1>a.chords.length?"":a.chords[0],g=document.getElementById("transposeOptions").getElementsByTagName("li"),h,d=-6;n.transpose="up_0";ugsEditorPlus.submenuUi.resetTransposeLabel();for(i=0;i<g.length;i++)ukeGeeks.toolsLite.removeClass(g[i],"checked"),h=1>m.length?"":ukeGeeks.transpose.shift(m,d),g[i].getElementsByTagName("em")[0].innerHTML=h,0===d&&ukeGeeks.toolsLite.addClass(g[i],
"checked"),d++}};return b}();
ugsEditorPlus.songUi=function(){var b={},c=function(a,c){var b=c&&0<c.length,k=document.getElementById(a);k&&(k.innerHTML=b?c:"",k.style.display=b?"block":"none")};b.update=function(a){var b=document.getElementById("songTitle");b.innerHTML=0<a.title.length?a.title:"Untitled-Song";c("songArtist",a.artist);c("songAlbum",a.album);c("songSubtitle",a.st);b=document.getElementById("songMeta");if(!a.ugsMeta||1>a.ugsMeta.length)b.style.display="none";else{for(var f="",k=0;k<a.ugsMeta.length;k++)f+="<p>"+
a.ugsMeta[k]+"</p>";b.innerHTML=f;b.style.display="block"}};return b}();
ugsEditorPlus.styles=new function(){var b=null;this.Rules=null;this.getSheet=function(c){a:{for(var a=0;a<document.styleSheets.length;a++)if(document.styleSheets[a].title==c){b=document.styleSheets[a];break a}b=null}c=null==b?[]:b.cssRules?b.cssRules:b.rules;this.Rules=c;return this};this.Find=function(b){b=b.toLowerCase();for(var a=0;a<this.Rules.length;a++)if(this.Rules[a].selectorText&&this.Rules[a].selectorText.toLowerCase()==b)return this.Rules[a];return null}};
ugsEditorPlus.themes=new function(){var b={normal:{name:"Normal (white paper)",selectText:"Normal colors (white paper)",description:"Simple, legible text on white paper",song:{fretLines:"#003366",dots:"#ff0000",dotText:"#ffffff",text:"#000000",fretText:"#4a4a4a"},tabs:{lines:"#999999",dots:"#eaeaea",text:"#000000"}},reversed:{name:"Reversed for projectors",selectText:"Reversed colors (for projectors)",description:"Light text on dark background",song:{fretLines:"#365F70",dots:"#FDD96F",dotText:"#000000",
text:"#FF6040",fretText:"#999999"},tabs:{lines:"#365F70",dots:"#FDD96F",text:"#000000"}},frosty:{name:"Frostcicle",selectText:"Frostcicle (cool blue)",description:"Brrrr... icy cool blues",song:{fretLines:"#66B4CC",dots:"#332335",dotText:"#9FE1F9",text:"#0896FE",fretText:"#E3D8BA"},tabs:{lines:"#6699FF",dots:"#EFFCF9",text:"#00558E"}},jellyBean:{name:"Jelly Beans",selectText:"Jelly Beans (vibrant)",description:"Sugary, vibrant bowl of jelly beans!",song:{fretLines:"#49BC45",dots:"#FF9417",dotText:"#FCF49F",
text:"#D20070",fretText:"#4a4a4a"},tabs:{lines:"#6699FF",dots:"#FFF9BA",text:"#75003E"}},justBlack:{name:"Just Black",selectText:"Black (for laser printers)",description:"No color, but black, best for B&W laser printers",song:{fretLines:"#cccccc",dots:"#000000",dotText:"#ffffff",text:"#000000",fretText:"#000000"},tabs:{lines:"#cccccc",dots:"#000000",text:"#ffffff"}},krampus:{name:"Gruss vom Krampus",selectText:"Krampus (Ye Olde Christmas)",description:"Seasons Greetin's, Happy Holidays, Merry Christmas, Krampus Nichte!",
song:{fretLines:"#929867",dots:"#A22C27",dotText:"#EBD592",text:"#4F2621",fretText:"#4a4a4a"},tabs:{lines:"#B69C01",dots:"#E1EEC8",text:"#75003E"}},western:{name:"Out West",selectText:"Out West (dust country)",description:"Dusty Honky Tonk/Country/Western look",song:{fretLines:"#B5A679",dots:"#CF8300",dotText:"#ffffff",text:"#386571",fretText:"#4a4a4a"},tabs:{lines:"#697665",dots:"#F1E3C5",text:"#632424"}},pumpkin:{name:"Pumpkin Pie",selectText:"Pumpkin Pie (fall colors)",description:"Fall 'n Halloween 'n Jack o'Lantern 'n Thanksgiving Fun",
song:{fretLines:"#8E9A6C",dots:"#DA6328",dotText:"#FFEE4A",text:"#68391D",fretText:"#B14623"},tabs:{lines:"#BED379",dots:"#FFF4D8",text:"#B14623"}},notebook:{name:"Rock Notebook",selectText:"Rock Notebook (marker)",description:"A strong, hand-scrawled, and edgily unreliable look",song:{fretLines:"#747CAD",dots:"#1C0866",dotText:"#ffffff",text:"#B22000",fretText:"#A4A0B2"},tabs:{lines:"#A4A0B2",dots:"#F1E3C5",text:"#2E2ECC"}},zombie:{name:"Zombies!!!",selectText:"Zombies!!!",description:"Blood 'n gore for Halloween",
song:{fretLines:"#9EB036",dots:"#E52501",dotText:"#FEDA79",text:"#798666",fretText:"#B14623"},tabs:{lines:"#602749",dots:"#F7F9EA",text:"#4F5F3E"}}};this.getDescription=function(c){return b[c].selectText};this.loadList=function(c){var a="",e;for(e in b)b.hasOwnProperty(e)&&(a+='<li class="'+("normal"==e?"checked":"")+'"><a href="#'+e+'" title="'+b[e].description+'">'+b[e].name+"</a></li>");$(c).html(a)};this.set=function(c){var a=$("body"),e;for(e in b)b.hasOwnProperty(e)&&a.removeClass("theme-"+
e);a.addClass("theme-"+c);c=b[c];ukeGeeks.settings.colors=c.song;ukeGeeks.settings.tabs.lineColor=c.tabs.lines;ukeGeeks.settings.tabs.dotColor=c.tabs.dots;ukeGeeks.settings.tabs.textColor=c.tabs.text}};
ugsEditorPlus.optionsDlg=function(){var b={},c=null,a,e,f;b.init=function(b){c=b;a=document.getElementById("commonChordList");e=document.getElementById("chkIgnoreCommon");f=document.getElementById("chkEnclosures");a.value=ukeGeeks.settings.commonChords.join(", ");e.checked=ukeGeeks.settings.opts.ignoreCommonChords;f.checked=!ukeGeeks.settings.opts.retainBrackets;document.getElementById("updateBtn").onclick=function(){c("update",null);return!1};f.onclick=function(){c("showEnclosures",!this.checked)};
a.onchange=function(){c("setCommonChords",a.value)};e.onclick=function(){c("hideCommonChords",this.checked)};$(".checkboxBlock label, input[type=checkbox]").click(function(a){a.stopPropagation()});$(".overlay").draggable({handle:"hgroup"})};return b}();var ugsEditorPlus=window.ugsEditorPlus||{};
ugsEditorPlus.reformat=new function(){var b=!1,c=function(){this.source="";this.spaceCount=this.wordCount=0;this.words=[];this.lineType=this.chordCount=0},a=/\b(\S+)\b/gi,e=/(\s+)/g,f=/(^\s+)/,k=/\b[A-G][#b]?(m|m6|m7|m9|dim|dim7|maj7|sus2|sus4|aug|6|7|9|add9|7sus4)?\b/,n=/\b(\S+\s*)/g,q=/^\s*(\|{0,2}[A-Gb]?\|{0,2}[-x0-9|:]{4,})/;this.run=function(m){b=!1;var g=[];m=m.replace("\t","    ");m=m.split("\n");for(var h=0;h<m.length;h++){var d=m[h].match(a),l=new c;l.source=m[h];if(null!=d&&0<d.length){l.wordCount=
d.length;l.words=d;for(var p=l,r=0,s=0;s<d.length;s++)d[s].match(k)&&r++;p.chordCount=r}p=m[h].match(e);null!=p&&0<p.length&&(l.spaceCount=p.length);p=l;d=l;1>d.spaceCount+d.wordCount?d=0:null!=d.source.match(q)?d=3:(r=2,0<d.chordCount&&d.wordCount==d.chordCount&&(r=1,b=!0),d=r);p.lineType=d;g.push(l)}h="";for(m=0;m<g.length;)if(l=g[m],p=g[m+1],m++,p&&0!=l.lineType){if(d=3==l.lineType)a:if(m+3>=g.length)d=!1;else{for(d=m;d<m+3;d++)if(3!=g[d].lineType){d=!1;break a}d=!0}if(d)h+="{start_of_tab}\n"+
l.source.replace(f,"")+"\n"+p.source.replace(f,"")+"\n"+g[m+1].source.replace(f,"")+"\n"+g[m+2].source.replace(f,"")+"\n{end_of_tab}\n",m+=3;else if(1!=l.lineType||2!=p.lineType){if(1==l.lineType){l=l.source.replace(e," ").split(" ");p="";for(d=0;d<l.length;d++)0<l[d].length&&(p+="["+l[d]+"] ");l=p+"\n"}else l=l.source+"\n";h+=l}else{m++;r=l.source;for(l=p.source;l.length<r.length;)l+=" ";p="";d=r.match(n);s=r.match(f);r=0;s&&(p+=l.substr(r,s[0].length),r=s[0].length);for(s=0;s<d.length;s++)p+="["+
d[s].replace(e,"")+"]"+l.substr(r,d[s].length),r+=d[s].length;r<l.length&&(p+=l.substr(r,l.length));h+=p+"\n"}}else h+=l.source+"\n";return h};this.hasChords=function(){return b}};
ugsEditorPlus.autoReformat=function(){var b={},c={},a,e=!1;b.run=function(b){e||(c=b,c.reformatTextBox=document.getElementById("reformatSource"),c.reformatDlg=document.getElementById("reformatDlg"),document.getElementById("reformatYesBtn").onclick=function(){c.cpmSource.value=a;f();ugsEditorPlus.actions.run(!0);return!1},document.getElementById("reformatNoBtn").onclick=function(){f();return!1},b=document.getElementById("reformatDisable"),b.checked=!1,b.onclick=function(){e=this.checked},a=ugsEditorPlus.reformat.run(c.cpmSource.value),
c.reformatTextBox.innerHTML=a,ugsEditorPlus.reformat.hasChords()&&ukeGeeks.toolsLite.removeClass(c.reformatDlg,"isHidden"))};var f=function(){ukeGeeks.toolsLite.addClass(c.reformatDlg,"isHidden")};return b}();
ugsEditorPlus.topMenus=function(){var b={init:function(){$("#ugsAppToolbar > ul li").not("[data-dialog]").children("a").click(c);$(".showOptionsBox a").click(n);$("#ugsAppToolbar > ul li[data-dialog]").click(e);$(".closeBtn").click(f);$(".resizeBtn").click(k)}},c=function(){var b=$(this).parent(),c=b.hasClass("active");a();c||b.addClass("active")},a=function(){$("#ugsAppToolbar > ul > li").removeClass("active")},e=function(a){a=$(this).data("dialog");$("#"+a).fadeIn();return!1},f=function(a){$(this).parents(".overlay").fadeOut();
return!1},k=function(a){a=$(this).parents(".overlay");ugsEditorPlus.resize.toggle(a);return!1},n=function(a){a=$(this).attr("href");$(".arrowBox").not(a).hide();a=$(a);a.find("dd").hide();a.fadeToggle();ugsEditorPlus.submenuUi.reset(a);return!1};b.makeAllInactive=a;return b}();
ugsEditorPlus.submenuUi=function(){var b={},c=null,a=null;b.init=function(b){a=b;ugsEditorPlus.themes.loadList("#colorPicker .pseudoSelect");$(".enablePseudoSelects label").click(f);$(".pseudoSelect li").click(e);$("body").bind("click",q);$(".arrowBox").click(n)};var e=function(b){b=$(this);var d;d=b.children().attr("href");d="#"==d[0]?d.substr(1):d;var m=b.parents("dd"),e=m.attr("id"),m=m.data("action");$("#"+e).hide().find("li").removeClass("checked");b.addClass("checked");k(this,!1);c=null;$("label[for="+
e+"] span").text(g(m,d,b));$("label[for="+e+"]").parents("dt").removeClass("active");a(m,d);return!1},f=function(a){a=$(this);var b=a.attr("for");a.closest("dl").children("dt").removeClass("active");a.closest("dt").addClass("active");$("#"+b).show();k(this,!0);null!=c&&$("#"+c.id).hide();c=null!=c&&c.id==b?null:{id:b};return!1};b.reset=function(a){a.find("dt").removeClass("active");a.find(".event-userSelecting").removeClass("event-userSelecting")};var k=function(a,b){$(a).parents(".enablePseudoSelects").toggleClass("event-userSelecting",
b)},n=function(a){if(!$(a.target).is("a"))return $(this).find("dd").hide(),c=null,!1},q=function(a){$(".arrowBox").fadeOut(270);ugsEditorPlus.topMenus.makeAllInactive()},m={zoomDiagrams:["Tiny","Small","Medium","Large","Stupid Large"],layout:["Reference diagrams on left","Reference diagrams at top","No reference diagrams"],placement:["Chord names inline with lyrics","Chord names above lyrics","Names & diagrams above lyrics"],tuning:["Soprano (GCEA) tuning","Baritone (DBEA) tuning"]},g=function(a,
b,g){var c=g.index();switch(a){case "paper":return"Width "+g.text();case "zoomFonts":return"Font size "+b+"pt";case "zoomDiagrams":return m.zoomDiagrams[c]+" diagrams";case "colors":return ugsEditorPlus.themes.getDescription(b);case "transpose":return"up_0"==b?"Original key":g.text().replace(" ",' steps - "')+'"';default:return m[a][c]}};b.resetTransposeLabel=function(){$("label[for=transposePicker] span").text("Original key")};return b}();
ugsEditorPlus.newSong=function(){var b={},c=!1,a="";b.init=function(b){a=b;$("#newSongBtn").click(function(a){a=$("#songTitle");var b=a.val().trim();a.val(b);a=2<b.length;f(!a,"Song's title is required<br/><em>(you may change it later, must be at least 2 characters)</em>");a&&e()});$("#openNewDlgBtn").click(function(a){$("#songTitle, #songArtist").val("");$("#newSongForm").fadeIn();$("#songTitle").focus()});$("#hideNewSongBtn").click(k);$("#newSongForm").bind("keydown",n);$spinner=$("#loadingSpinner");
$spinner.hide();$(document).ajaxStart(function(){$spinner.show();c=!0}).ajaxStop(function(){$spinner.hide();c=!1})};var e=function(){if(!c){var b={handler:"ugs_new",songTitle:$("#songTitle").val(),songArtist:$("#songArtist").val()};$.ajax({url:a,type:"POST",dataType:"json",data:JSON.stringify(b),success:function(a){f(a.HasErrors,a.Message);a.HasErrors||(document.location.href=a.ContinueUri)}})}},f=function(a,b){var g=$("#newSongForm .errorMessage");a?(g.show().html(b),$("#songTitle").focus()):g.hide()},
k=function(a){$("#newSongForm").fadeOut()},n=function(a){27==a.which&&k()};return b}();
ugsEditorPlus.updateSong=function(){var b={},c="",a="",e=!1;b.init=function(b,n){c=b;a=n;$("#saveBtn").click(function(a){f();return!1});$("#messageBox").hide();$(document).ajaxStart(function(){$("#sourceFeedback").hide().html();$("#messageBox").slideDown("fast");$("#loadingSpinner").show();e=!0}).ajaxStop(function(){$("#messageBox").delay(3E3).fadeOut("slow");e=!1})};var f=function(){if(!e){$("#sourceFeedback").show();var b={handler:"ugs_update_81jr",filename:a,song:$("#chordProSource").val()};$.ajax({url:c,
type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(b),success:function(a){a=a.Message;$("#loadingSpinner").hide();$("#sourceFeedback").show().html(a)}})}};return b}();
ugsEditorPlus.typeahead=function(){var b={},c=[],a={},e="",f,k=[],n=/\s{2,}/g,q=/([^a-z0-9]+)/gi,m=/['`\u2019-]/g,g=function(){$("li").each(function(b){var g=$(this);b=h(g.text());var d=g.children("a").attr("href"),e=d.toLowerCase(),g=g.children("a").html(),g=g.replace('<strong class="','<span class="bigger ').replace("</strong>","</span>");a[e]={html:g,searchText:b,code:e,href:d};c.push(e)})},h=function(a){return a.toLowerCase().replace(m,"").replace(q," ").replace(n," ").trim()},d=function(a,b){e=
h(a);k=e.split(" ");for(var g="",d=0;d<k.length;d++)k[d]=k[d].trim(),0<k[d].length&&(g+=(0<g.length?"|":"")+k[d]);f=RegExp("("+g+")","gi");b(c)},l=function(b){window.location=a[b].href;return a[b].searchText},p=function(b){b=a[b];for(var g=0;g<k.length;g++)if(-1==b.searchText.indexOf(k[g]))return!1;return!0},r=function(b){return b.sort(function(b,g){return a[b].searchText>a[g].searchText})},s=function(b){b=$("<div/>").html(a[b].html);$("em, .bigger",b).each(function(a){a=$(this);var b=a.html();a.html(b.replace(f,
"<strong>$1</strong>"))});return b.html()};b.initialize=function(){g();$("#quickSearch").typeahead({source:d,updater:l,matcher:p,sorter:r,highlighter:s,minLength:2,items:50}).val("").focus()};return b};
ugsEditorPlus.resize=function(){var b={},c=null,a=null,e=null,f=null,k=!1,n=!1,q=function(b){c=$(b);$("body").append('<div id="aceHeader"><button class="aceSideBtn" title="Show options &amp; help"><span></span><span></span><span></span></button><strong>Edit Song</strong><a href="#exit-fullscreen">Exit fullscreen</a></div><div id="aceEditor"></div><div id="aceHelp"></div>');a=$("#aceEditor");a.fadeOut(1);e=$("#aceHelp");$("#aceHeader a").click(function(a){a.preventDefault();l()});$("#aceHeader button").click(m)},
m=function(a){a.preventDefault();g(!n)},g=function(b){(n=b)?(e.animate({left:0},400),a.animate({left:"350px"},400)):(e.animate({left:"-350px"},400),a.animate({left:0},400))},h=function(){k=!0;$("html").addClass("aceEditorActive");$(".overlay").fadeOut(300);null===f?LazyLoad.js("/js/ace/ace.js",function(){f=ace.edit("aceEditor");f.setTheme("ace/theme/idle_fingers");f.getSession().setMode("ace/mode/chordpro");f.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0});f.completers=[ugsAce.chordCompleter];
d();e.html(ugsAce.helpHtml)}):d()},d=function(){a.fadeIn(550);f.setValue($("#chordProSource").val());f.gotoLine(1);e.fadeIn(1)},l=function(){k=!1;c.show();a.fadeOut(550);e.fadeOut(550);null!==f&&$("#chordProSource").val(f.getValue());$("html").removeClass("aceEditorActive");g(!1)};b.toggle=function(a){null===c&&q(a);k?l():h();return!1};return b}();
ugsEditorPlus.chordBuilder=function(){var b={},c=null;b.init=function(){var b=$(".fingerToolImage").css("background-image");ugsChordBuilder.settings.cursor.imageUri=b.replace(/url\("(.*)hand.png"\)/i,"$1hand-cursor.png");c=new ugsChordBuilder.editorUi;c.init();$("#cdBldOpenBtn").click(a)};var a=function(a){a.preventDefault();c.reload();a=$(this).data("dialog");$("#"+a).fadeIn()};return b}();var ugsChordBuilder=window.ugsChordBuilder||{};
ugsChordBuilder.entities={BoundingBox:function(b,c){this.x=b?b.x:0;this.y=b?b.y:0;this.width=c?c.width:1;this.height=c?c.height:1},Dot:function(b,c,a){this.string=b;this.fret=c?c:0;this.finger=a?a:0},Position:function(b,c){this.x=b?b:0;this.y=c?c:0}};
ugsChordBuilder.settings=function(){var b=ugsChordBuilder.entities,c={x:75,y:75},a={numFrets:5,maxFret:16,stringNames:["G","C","E","A"],strokeWidth:4,strokeColor:"#8F8569",fretSpace:35,stringSpace:30},e=function(){return{height:a.fretSpace,width:a.stringSpace}};return{anchorPos:c,cursor:{fillColor:"rgba(220, 216, 73, 0.35)",strokeWidth:1,strokeColor:"#AAB444",radius:9,imageUri:"/img/editor/hand-cursor.png"},fretBoard:a,dot:{fillColor:"#F68014",radius:11,strokeWidth:2,strokeColor:"#D56333",fontWeight:"bold",
fontFamily:'Arial, "Helvetica Neue", Helvetica, Verdana, sans-serif',fontSize:16,fontColor:"#ffffff"},fretLabel:{fontFamily:'Arial, "Helvetica Neue", Helvetica, Verdana, sans-serif',fontSize:28,color:"#6A6A63",lightColor:"#EAEAE8"},stringLabel:{fontFamily:'Arial, "Helvetica Neue", Helvetica, Verdana, sans-serif',fontSize:34,color:"#DCD849"},chord:{nameMaxLength:20},targetDimensions:e,targetAnchorPos:function(){var f=e();return new b.Position(c.x-0.5*f.width,c.y-f.height-0.2*a.strokeWidth)},centerAnchor:function(b){c.x=
0.5*b.width-0.5*(a.stringNames.length-1)*a.stringSpace-a.strokeWidth;c.y=0.5*b.height-0.5*a.numFrets*a.stringSpace}}}();
ugsChordBuilder.tracking=new function(){var b=ugsChordBuilder.entities,c=ugsChordBuilder.settings,a=null;this.toDot=function(e){var f=new b.BoundingBox(e),k;a||(k=c.targetDimensions(),k.width*=c.fretBoard.stringNames.length,k.height*=c.fretBoard.numFrets+1,a=new b.BoundingBox(c.targetAnchorPos(),k));k=a;if(!(f.x<k.x+k.width&&f.x+f.width>k.x&&f.y<k.y+k.height&&f.y+f.height>k.y))return null;f=c.targetDimensions();return new b.Dot(Math.floor((e.x-k.x)/f.width),Math.floor((e.y-k.y)/f.height))}};
ugsChordBuilder.fretDots=new function(){var b=ugsChordBuilder.entities,c=ugsChordBuilder.settings.anchorPos,a=ugsChordBuilder.settings.fretBoard,e=ugsChordBuilder.settings.dot,f=[];this.getDots=function(){return f.slice()};this.slide=function(b){var c;a:{for(c=0;c<f.length;c++)if(1>f[c].fret+b||f[c].fret+b>a.numFrets){c=!1;break a}c=!0}if(!c)return!1;for(c=0;c<f.length;c++)f[c].fret+=b;return!0};this.toggleDot=function(a){if(0==a.fret)n(a.string);else{var b=k(a);0>b?f.push(a):f.splice(b,1)}};this.toggleFinger=
function(a,b){var g=k(a);if(0>g)return!1;f[g].finger=f[g].finger==b?0:b;return!0};this.reset=function(){for(var b=0;b<a.stringNames.length;b++)n(b)};var k=function(a){for(var b=f.length-1;0<=b;b--)if(f[b].string==a.string&&f[b].fret==a.fret)return b;return-1},n=function(a){for(var b=f.length-1;0<=b;b--)f[b].string==a&&f.splice(b,1)};this.draw=function(k){for(var m=f.length-1;0<=m;m--){var g;g=f[m];g=new b.Position(c.x+0.47*a.strokeWidth+g.string*a.stringSpace,c.y+0.47*a.strokeWidth+(g.fret-0.5)*a.fretSpace);
var h=k,d=g;h.beginPath();h.arc(d.x,d.y,e.radius,0,2*Math.PI,!1);h.fillStyle=e.fillColor;h.fill();h.lineWidth=e.strokeWidth;h.strokeStyle=e.strokeColor;h.stroke();0<f[m].finger&&(h=k,d=f[m].finger,h.font=e.fontWeight+" "+e.fontSize+"px "+e.fontFamily,h.textAlign="center",h.fillStyle=e.fontColor,h.fillText(d,g.x,g.y+0.3*e.fontSize))}}};
ugsChordBuilder.cursorCanvas=new function(){var b=ugsChordBuilder.settings.cursor,c=ugsChordBuilder.settings.dot,a=null,e=null,f=!1,k=!0,n=1,q={x:0,y:0};this.init=function(b){a=b;m()};var m=function(){e=new Image;e.onload=function(){f=!0};e.src=b.imageUri};this.setCursor=function(b,a){k=b;n=a};this.draw=function(g){var h=b.radius+b.strokeWidth;a.clearRect(q.x-h,q.y-h,h+50,h+60);!f||k?(a.beginPath(),a.arc(g.x,g.y,b.radius,0,2*Math.PI,!1),a.fillStyle=b.fillColor,a.fill(),a.lineWidth=b.strokeWidth,a.strokeStyle=
b.strokeColor,a.stroke()):(a.drawImage(e,g.x,g.y),a.font=c.fontWeight+" "+c.fontSize+"px "+c.fontFamily,a.textAlign="left",a.fillStyle="black",a.fillText(n,g.x+0.8*e.width,g.y+e.height));q=g}};
ugsChordBuilder.chordCanvas=new function(){var b=ugsChordBuilder.entities,c=ugsChordBuilder.settings.centerAnchor,a=ugsChordBuilder.settings.anchorPos,e=ugsChordBuilder.settings.fretLabel,f=ugsChordBuilder.settings.stringLabel,k=ugsChordBuilder.settings.fretBoard,n=null,q=null;this.init=function(b,a){n=b;q=a;c(q)};this.draw=function(c,g){n.clearRect(0,0,q.width,q.height);for(var h=new b.Position(a.x-0.3*e.fontSize,a.y+e.fontSize),d=1<g?e.color:e.lightColor,l=0;l<k.numFrets;l++){var p=g+l,r=h;n.font=
e.fontSize+"px "+e.fontFamily;n.textAlign="right";n.fillStyle=d;n.fillText(p,r.x,r.y);h.y+=k.fretSpace;d=e.lightColor}h=new b.Position(a.x+0.5*k.strokeWidth,a.y-0.25*e.fontSize);for(l=0;l<k.stringNames.length;l++)p=k.stringNames[l],d=h,n.font=f.fontSize+"px "+f.fontFamily,n.textAlign="center",n.fillStyle=f.color,n.fillText(p,d.x,d.y),h.x+=k.stringSpace;l=k.strokeWidth/2;p=k.numFrets*k.fretSpace;d=(k.stringNames.length-1)*k.stringSpace;n.beginPath();for(h=1;h<k.stringNames.length-1;h++)r=a.x+h*k.stringSpace+
l,n.moveTo(r,a.y+l),n.lineTo(r,a.y+p+l);for(h=1;h<k.numFrets;h++)r=a.y+h*k.fretSpace+l,n.moveTo(a.x+l,r),n.lineTo(a.x+d+l,r);n.rect(a.x+l,a.y+l,d,p);n.strokeStyle=k.strokeColor;n.lineWidth=k.strokeWidth;n.stroke();n.closePath();ugsChordBuilder.fretDots.draw(n)}};
ugsChordBuilder["export"]=new function(){var b=ugsChordBuilder.settings.fretBoard,c=ugsChordBuilder.settings.chord,a=null,e=function(b,a){this.string=b;this.dots=a?a:[]},f=function(){var a,c=[];for(a=1;a<=b.stringNames.length;a++)c.push(new e(a));var d=ugsChordBuilder.fretDots.getDots();for(a=c.length-1;0<=a;a--)for(var f=d.length-1;0<=f;f--)c[a].string==d[f].string+1&&c[a].dots.push(d[f]);return c},k=function(a){for(var b=0,c=900,e=a.length-1;0<=e;e--)a[e].fret>b&&(b=a[e].fret),a[e].fret<c&&(c=a[e].fret);
return{max:b,min:900>c?c:b}},n=function(b){return 0<b?a+b:0},q=function(a,b){for(var c=0;c<a.length;c++)if(a[c].fret==b)return a[c].finger;return 0};this.getPrimaryFrets=function(b){a=b-1;b=f();for(var c=[],d=0;d<b.length;d++){var e=k(b[d].dots);c.push(n(e.max))}return c};this.getDefinition=function(b,c){var d=(b=m(b))&&0<b.length?b:"CHORDNAME",e="",p="",r="";a=c-1;for(var s=f(),v=0;v<s.length;v++){var w=k(s[v].dots),e=e+(n(w.max)+" "),p=p+(q(s[v].dots,w.max)+" ");w.max!=w.min&&(r+=" add: string "+
s[v].string+" fret "+n(w.min)+" finger "+q(s[v].dots,w.min))}return("{define: "+d+" frets "+e+" fingers "+p+r+"}").replace(/\s+/g," ").replace(" }","}")};this.getDefinitionHtml=function(b,a){b=m(b);var c=this.getDefinition(b,a),c=c.replace(" "+b," X07Myq791wso01"),c=c.replace(/\b(\d+)\b/g,'<span class="chordPro-X07MX001number">$1</span>'),c=c.replace(/\b(frets?|fingers?|string)\b/g,'<span class="chordPro-X07MX001attribute">$1</span>'),c=c.replace(/\b(define|add)\b/g,'<span class="chordPro-X07MX001keyword">$1</span>');
return c.replace("X07Myq791wso01",'<span class="chordPro-string">'+b+"</span>").replace(/X07MX001/g,"").replace(/ +/g," ")};var m=function(b){b=b.replace(/^\s*(.*?)\s*$/,"$1").replace(/\s+/g,"-");/^(frets|fingers|add:)$/i.test(b)&&(b="");return b.substring(0,c.nameMaxLength)}};
ugsChordBuilder.chooserList=new function(){var b=[],c=null,a=0,e=null,f=function(){},k=this,n=null,q={showText:!1,height:50,width:40,fretSpace:9,stringSpace:7,dotRadius:3,lineWidth:1,topLeftPos:{x:10,y:2},xWidth:0.7*7,xStroke:1.4},m={dot:"8pt Arial",text:"8pt Arial",fret:"8pt Arial"},g={fretLines:"#EED18E",dots:"#551D00",dotText:"#ffffff",text:"#000000",fretText:"#EED18E",xStroke:"#551D00"},h=function(b,c){this.id=a++;this.name=b;this.definition=c};this.init=function(b){f=b;c=document.getElementById("cdBldPick");
c.addEventListener("click",l,!1);d()};var d=function(){for(var a=/\{define:\s*([^}]+?)\s+frets[^}]+?\}/im,e=document.getElementById("chordProSource").value.split("\n"),d=e.length-1;0<=d;d--)a.test(e[d])&&A(e[d].replace(a,"$1"),e[d]);for(var e=c,d=b,f="",a=0;a<d.length;a++)f+=r(d[a].id,d[a].name);e.innerHTML='<li data-id="-1" class="newChord">+ Add New Chord</li>'+f;e=e.getElementsByTagName("li");for(a=e.length-1;0<=a;a--)1>a||s(e[a].getAttribute("data-id"))};this.reset=function(){b=[];document.getElementById("cdBldPick").innerHTML=
"";a=0;e=null;d()};this.show=function(b){document.getElementById("cdBldChooserPanel").style.display=b?"block":"none";document.getElementById("cdBldBuilderPanel").style.display=b?"none":"block";$("#cdBldChooserPanel").closest(".overlay").toggleClass("chordBuilderNarrow",b)};this.save=function(a){var d;a:{d=null==e?-1:e.id;for(var f=a.name.toLowerCase(),g=b.length-1;0<=g;g--)if(""+b[g].id!=""+d&&b[g].name.toLowerCase()==f){d=g;break a}d=-1}if(0<=d)return alert("Hey, this chord name is already being used."),
!1;d=-1;if(null==e){d=A(a.name,a.definition);e=y(d);a=a.definition;for(var f=document.getElementById("chordProSource"),g=/\s*\{\s*(title|t|artist|subtitle|st|album|define):.*?\}/im,h=f.value.split("\n"),k="",l=!1,m=h.length-1;0<=m;m--)!l&&g.test(h[m])&&(k=a+"\n"+k,l=!0),k=h[m]+"\n"+k;f.value=k;ugsEditorPlus.actions.run()}else{f=z(e.id);if(0>f)return!1;g=b[f].definition;b[f].name=a.name;b[f].definition=a.definition;d=b[f].id;w(g,b[f].definition)}a=y(d);(f=p(d))?f.innerHTML=r(d,a.name,!0):(a=a.name,
f=document.createElement("ul"),f.innerHTML=r(d,a),c.appendChild(f.childNodes[0]));s(d);this.show(!0);return!0};var l=function(a){a.preventDefault();e=y(a.target.getAttribute("data-id"));if("delete"==a.target.getAttribute("data-action")){if(a=e,confirm('Delete definition for "'+a.name+'"?')){var b=p(a.id);b&&(c.removeChild(b),w(a.definition,""))}}else{a=null;if(null!=e){a=ukeGeeks.chordImport.runLine(e.definition);a:{if(a.muted)for(b=0;b<a.muted.length;b++)if(a.muted[b]){b=!0;break a}b=!1}b&&alert("Uh-oh! This chord uses muted strings!\nCurrently the Chord Builder does not support muted strings -- \nsaving edits will result in mutes being lost.")}f(a);
k.show(!1)}},p=function(a){for(var b=c.getElementsByTagName("li"),d=0;d<b.length;d++)if(b[d].getAttribute("data-id")==""+a)return b[d];return null},r=function(a,b,c){c=2<arguments.length?c:!1;var d='<span class="deleteChord" data-id="'+a+'" data-action="delete" title="Remove this definition"></span>'+b;return c?d:'<li data-id="'+a+'" title="Edit this definition" class="ugs-grouped">'+d+"</li>"},s=function(a){var b=p(a);a=y(a);a=ukeGeeks.chordImport.runLine(a.definition);null==n&&(n=new ukeGeeks.chordBrush);
n.plot(b,a,q,m,g)},v=function(a,b,c){var d=a.replace(b,c);return d==a?a:v(d,b,c)},w=function(a,b){var c=document.getElementById("chordProSource");c.value=v(c.value,a,b);ugsEditorPlus.actions.run()},z=function(a){for(var c=0;c<b.length;c++)if(""+b[c].id==a)return c;return-1},y=function(a){a=z(a);return 0<=a?b[a]:null},A=function(a,c){var d=new h(a,c);b.push(d);return d.id}};
ugsChordBuilder.editorUi=function(){var b=null,c=null,a=null,e=1,f="",k=!0,n=0,q={0:"None",1:"Index finger",2:"Middle finger",3:"Ring finger",4:"Pinkie"};this.init=function(){b=document.getElementById("cdBldCursorCanvas");if(!b.getContext)return!1;for(var e=b.getContext("2d"),f=document.getElementById("cdBldDiagramCanvas").getContext("2d"),k=document.getElementById("cdBldStartingFret"),p="",n=ugsChordBuilder.settings.fretBoard.maxFret-ugsChordBuilder.settings.fretBoard.numFrets+1,s=1;s<=n;s++)p+=
'<option value="'+s+'">'+s+"</option>";k.innerHTML=p;k.addEventListener("change",w,!1);document.getElementById("cdBldChordName").addEventListener("keyup",v,!1);c=document.getElementById("cdBldDotsBtn");a=document.getElementById("cdBldFingersBtn");c.addEventListener("click",r,!1);a.addEventListener("click",r,!1);document.getElementById("cdBldShowOutputBtn").addEventListener("click",g,!1);document.getElementById("cdBldCancelBtn").addEventListener("click",h,!1);document.getElementById("cdBldSaveBtn").addEventListener("click",
d,!1);document.getElementById("toolboxSlideUpBtn").addEventListener("click",z,!1);document.getElementById("toolboxSlideDownBtn").addEventListener("click",z,!1);m();document.getElementById("cdBldEditorSurface").addEventListener("mousemove",y,!1);b.addEventListener("click",A,!1);ugsChordBuilder.chordCanvas.init(f,b);ugsChordBuilder.cursorCanvas.init(e);x();t();ugsChordBuilder.chooserList.init(l);return!0};var m=function(){n++;4<n&&(n=0);document.getElementById("cdBldBtnFingerName").innerHTML=q[n]+" ("+
n+")";document.getElementById("cdBldBtnDiagram").className="fingerToolImage finger"+n},g=function(a){s(document.getElementById("cdBldOutputBox"),"collapseOutput",!a.target.checked)},h=function(a){a.preventDefault();p();ugsChordBuilder.chooserList.show(!0)},d=function(a){a.preventDefault();a={name:f,startingFret:e,dots:ugsChordBuilder.fretDots.getDots(),definition:ugsChordBuilder["export"].getDefinition(f,e)};ugsChordBuilder.chooserList.save(a)||(a=document.getElementById("cdBldChordName"),a.focus(),
a.select())},l=function(a){if(null==a)p();else{var b;b=a.dots;for(var c=0,d=0;d<b.length;d++)b[d].fret>c&&(c=b[d].fret);b=c;b=b>ugsChordBuilder.settings.fretBoard.numFrets?b-ugsChordBuilder.settings.fretBoard.numFrets+1:1;c=p;d=a.name;a=a.dots;for(var e=b-1,f=[],g=0;g<a.length;g++){var k=a[g].fret-e;f.push(new ugsChordBuilder.entities.Dot(a[g].string,0>k?0:k,a[g].finger))}c(d,b,f,!1)}},p=function(b,d,g,h){h=3<arguments.length?h:!0;ugsChordBuilder.fretDots.reset();var l=h;f=b&&0<b.length?b:"CHORDNAME";
document.getElementById("cdBldChordName").value=f;e=d?d:1;document.getElementById("cdBldStartingFret").value=e;document.getElementById("cdBldShowOutputBtn").checked=!1;s(document.getElementById("cdBldOutputBox"),"collapseOutput",!0);document.getElementById("cdBldSaveBtn").value=l?"Add":"Update";k=!0;n=0;m();s(c,"selected",k);s(a,"selected",!k);s(document.getElementById("cdBldToolbox"),"open",!k);ugsChordBuilder.cursorCanvas.setCursor(k,n);if(g&&0<g.length)for(l=0;l<g.length;l++)ugsChordBuilder.fretDots.toggleDot(g[l]);
x();t()},r=function(b){b.preventDefault();b=0<=b.currentTarget.href.indexOf("#dots");b==k?b||(m(),ugsChordBuilder.cursorCanvas.setCursor(k,n)):(s(c,"selected",b),s(a,"selected",!b),s(document.getElementById("cdBldToolbox"),"open",!b),k=b,ugsChordBuilder.cursorCanvas.setCursor(k,n))},s=function(a,b,c){var d=0<=a.className.indexOf(b);c&&!d?a.className+=" "+b:!c&&d&&(a.className=a.className.replace(b,"").replace(/\s+/g," "))},v=function(a){f=this.value;t()},w=function(a){e=parseInt(this.value,10);t();
x()},z=function(a){a.preventDefault();var b=!1;a="up"==a.target.getAttribute("data-direction")?-1:1;if(ugsChordBuilder.fretDots.slide(a))b=!0;else{a=e+a;var c=ugsChordBuilder.settings.fretBoard.maxFret-ugsChordBuilder.settings.fretBoard.numFrets+1;1<=a&&a<=c&&(e=a,document.getElementById("cdBldStartingFret").value=a,b=!0)}b&&(x(),t())},y=function(a){ugsChordBuilder.cursorCanvas.draw(u(this,a))},A=function(a){a=u(b,a);var c=ugsChordBuilder.tracking.toDot(a);c&&(k?(ugsChordBuilder.fretDots.toggleDot(c),
x(a),t()):ugsChordBuilder.fretDots.toggleFinger(c,n)&&(x(a),t()))},u=function(a,b){var c=a.getBoundingClientRect();return new ugsChordBuilder.entities.Position(b.clientX-c.left,b.clientY-c.top)},x=function(a){a=a||new ugsChordBuilder.entities.Position(0,0);ugsChordBuilder.chordCanvas.draw(a,e)},t=function(){document.getElementById("cdBldOutput").innerHTML=ugsChordBuilder["export"].getDefinitionHtml(f,e)};this.reload=function(){p();ugsChordBuilder.chooserList.reset();ugsChordBuilder.chooserList.show(!0)}};
LazyLoad=function(b){function c(a,c){var d=b.createElement(a),e;for(e in c)c.hasOwnProperty(e)&&d.setAttribute(e,c[e]);return d}function a(a){var b=g[a],c,e;b&&(c=b.callback,e=b.urls,e.shift(),h=0,e.length||(c&&c.call(b.context,b.obj),g[a]=null,d[a].length&&f(a)))}function e(){var a=navigator.userAgent;q={async:!0===b.createElement("script").async};(q.webkit=/AppleWebKit\//.test(a))||(q.ie=/MSIE|Trident/.test(a))||(q.opera=/Opera/.test(a))||(q.gecko=/Gecko\//.test(a))||(q.unknown=!0)}function f(f,
h,l,v,w){var z=function(){a(f)},y="css"===f,A=[],u,x,t,B;q||e();if(h)if(h="string"===typeof h?[h]:h.concat(),y||q.async||q.gecko||q.opera)d[f].push({urls:h,callback:l,obj:v,context:w});else for(u=0,x=h.length;u<x;++u)d[f].push({urls:[h[u]],callback:u===x-1?l:null,obj:v,context:w});if(!g[f]&&(B=g[f]=d[f].shift())){m||(m=b.head||b.getElementsByTagName("head")[0]);h=B.urls.concat();u=0;for(x=h.length;u<x;++u)l=h[u],y?t=q.gecko?c("style"):c("link",{href:l,rel:"stylesheet"}):(t=c("script",{src:l}),t.async=
!1),t.className="lazyload",t.setAttribute("charset","utf-8"),q.ie&&!y&&"onreadystatechange"in t&&!("draggable"in t)?t.onreadystatechange=function(){/loaded|complete/.test(t.readyState)&&(t.onreadystatechange=null,z())}:y&&(q.gecko||q.webkit)?q.webkit?(B.urls[u]=t.href,n()):(t.innerHTML='@import "'+l+'";',k(t)):t.onload=t.onerror=z,A.push(t);u=0;for(x=A.length;u<x;++u)m.appendChild(A[u])}}function k(b){var c;try{c=!!b.sheet.cssRules}catch(d){h+=1;200>h?setTimeout(function(){k(b)},50):c&&a("css");return}a("css")}
function n(){var b=g.css,c;if(b){for(c=l.length;0<=--c;)if(l[c].href===b.urls[0]){a("css");break}h+=1;b&&(200>h?setTimeout(n,50):a("css"))}}var q,m,g={},h=0,d={css:[],js:[]},l=b.styleSheets;return{css:function(a,b,c,d){f("css",a,b,c,d)},js:function(a,b,c,d){f("js",a,b,c,d)}}}(this.document);