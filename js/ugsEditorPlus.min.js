/**
  *
  * @module  UkeGeeksScriptasaurus Editor+
  * @namespace  ugsEditorPlus
  * @class ugsEditorPlus
  */
var ugsEditorPlus = new function(){
	/**
	 * attaches event handlers, preps variables, and runs UGS
	 * @method init
	 * @private
	 * @param isLegacyIe {bool} pre-IE 9 versions
	 */
	var init = function(isLegacyIe){
		// ukeGeeks.tumblr.opts.diagramResizeTo = 1;
		ukeGeeks.settings.opts.retainBrackets = false;

		ukeGeeks.scriptasaurus.init(isLegacyIe);

		ugsEditorPlus.menus.init();
		ugsEditorPlus.actions.init(isLegacyIe);
		ugsEditorPlus.actions.run();
	};

	/**
	 * wraps the private Init method for modern browsers
	 * @method attach
	 * @public
	 */
	this.attach = function(){
		init(false);
	};

	/**
	 * wraps the private Init method, required for Legacy Internet Exploere (pre-9)
	 * @method attach
	 * @public
	 */
	this.attachIe = function(){
		init(true);
	};

};

;ugsEditorPlus.actions=new function(){var _this=this;var _isCrap=false;var _ele={};var _song=null;var _sourceOriginal=null;var _originalChords=[];var _priorValue='#above';var re={safe:/^([A-G][#b]?)(m|m6|7|m7|dim|maj7|6|sus2|sus4|aug|9)?$/,};this.init=function(isLegacyIe){_isCrap=isLegacyIe;_ele={docBody:document.getElementsByTagName('body')[0],songText:document.getElementById('ukeSongText'),songContainer:document.getElementById('ukeSongContainer'),cpmSource:document.getElementById('chordProSource'),scalableArea:document.getElementById('scalablePrintArea')};document.getElementById('updateBtn').onclick=function(){doUpdate();return false;};var eSourceDlg=document.getElementById('songSourceDlg');document.getElementById('hideSourceBtn').onclick=function(){return doShowDlg(eSourceDlg,false);};document.getElementById('showSourceBtn').onclick=function(){return doShowDlg(eSourceDlg,true);};var eHelpDlg=document.getElementById('helpDlg');document.getElementById('hideHelpBtn').onclick=function(){return doShowDlg(eHelpDlg,false);};document.getElementById('showHelpBtn').onclick=function(){return doShowDlg(eHelpDlg,true);};var eOptionsDlg=document.getElementById('optionsDlg');document.getElementById('hideOptionsBtn').onclick=function(){return doShowDlg(eOptionsDlg,false);};document.getElementById('showOptionsBtn').onclick=function(){return doShowDlg(eOptionsDlg,true);};ugsEditorPlus.optionsDlg.init(this,_ele);};this.doClick=function(mainMenu,subMenu){switch(mainMenu){case'#zoom':doZoom(subMenu);break;case'#layout':doLayout(subMenu);break;case'#placement':doPlacement(subMenu);break;case'#tuning':doTuning(subMenu);break;case'#colors':doColors(subMenu);break;case'#transpose':doTranspose(subMenu);break;default:console.log('Unrecognized '+mainMenu+' > '+subMenu);}};var doUpdate=function(){_this.run(true);};var doZoom=function(subMenu){var prct=(parseInt(subMenu.substr(6),10)/100);var width=Math.round(prct*225);_ele.scalableArea.style.fontSize=(prct*12)+'pt';var s=ugsEditorPlus.styles.getSheet('ugsEditorCss');var m=s.Find('.scalablePrintArea .ugs-diagrams-wrap canvas');m.style.width=Math.round(prct*100)+'px';m=s.Find('.scalablePrintArea .ugs-diagrams-wrap');m.style.width=width+'px';m=s.Find('.scalablePrintArea .ugs-source-wrap');m.style.marginLeft=(25+width)+'px';};var doLayout=function(subMenu){ukeGeeks.toolsLite.setClass(_ele.docBody,'diagramsOnTop',(subMenu=='#top'));ukeGeeks.toolsLite.setClass(_ele.docBody,'diagramsOnSide',(subMenu=='#left'));ukeGeeks.toolsLite.setClass(_ele.docBody,'ugsHideDiagrams',(subMenu=='#none'));};var doPlacement=function(subMenu){ukeGeeks.toolsLite.setClass(_ele.songContainer,'ugsInline',(subMenu=='#inline'));var isMiniDiagrams=(subMenu=='#miniDiagrams');if(!isMiniDiagrams){ukeGeeks.toolsLite.removeClass(_ele.songContainer,'ugsInlineDiagrams');}
if(isMiniDiagrams||(_priorValue=='#miniDiagrams')){ukeGeeks.settings.inlineDiagrams=isMiniDiagrams;_this.run();}
_priorValue=subMenu;};var doTuning=function(subMenu){var tuning=(subMenu=='#baritone')?ukeGeeks.definitions.instrument.baritoneUke:ukeGeeks.definitions.instrument.sopranoUke;ukeGeeks.scriptasaurus.setTuningOffset(tuning);_this.run();};var _colorSchemes={'#reversed':{song:{fretLines:'#365F70',dots:'#FDD96F',dotText:'#000000',text:'#FF6040',fretText:'#999999'},tabs:{lines:'#365F70',dots:'#FDD96F',text:'#000000'}},'#normal':{song:{fretLines:'#003366',dots:'#ff0000',dotText:'#ffffff',text:'#000000',fretText:'#4a4a4a'},tabs:{lines:'#999999',dots:'#eaeaea',text:'#000000'}}};var doColors=function(subMenu){ukeGeeks.toolsLite.setClass(_ele.docBody,'reversed',subMenu=='#reversed');var c=_colorSchemes[subMenu];ukeGeeks.settings.colors=c.song;ukeGeeks.settings.tabs.lineColor=c.tabs.lines;ukeGeeks.settings.tabs.dotColor=c.tabs.dots;ukeGeeks.settings.tabs.textColor=c.tabs.text;_this.run();};var doTranspose=function(subMenu){var sign=subMenu[1]=='u'?1:-1;var steps=parseInt(subMenu[subMenu.length-1],10);transpose(sign*steps);};var doShowDlg=function(element,isActive){ukeGeeks.toolsLite.setClass(element,'isHidden',!isActive);return false;};this.run=function(isDoBackup){isDoBackup=(arguments.length>0)&&isDoBackup;_ele.songText.innerHTML='<pre>'+_ele.cpmSource.value+'</pre>';_song=ukeGeeks.scriptasaurus.run();if(_song.chords.length<1){ugsEditorPlus.autoReformat.run(_ele);}
if(_song){ugsEditorPlus.songUi.update(_song);if(isDoBackup||(_sourceOriginal==null)){_sourceOriginal=_ele.cpmSource.value;_originalChords=_song.chords;ugsEditorPlus.menus.resetTranspose(_song.chords.length<1?'':_song.chords[0]);}}};var transpose=function(steps){var safeChords=[];var bad='';for(var i=0;i<_originalChords.length;i++){if(re.safe.test(_originalChords[i])){safeChords.push(_originalChords[i]);}
else{bad+=_originalChords[i]+', ';}}
if(bad.length>0){if(!confirm('Sorry, but some of your chords can\'t be transposed:\n'+bad+'\n\nDo you want to continue anyway?')){return;}}
var newChords=ukeGeeks.transpose.shiftChords(safeChords,steps);var s=_sourceOriginal;var r;for(var i=0;i<safeChords.length;i++){r=new RegExp('\\['+safeChords[i]+'\\]','g');s=s.replace(r,'[ugsxx_'+i+']');}
for(var i=0;i<newChords.length;i++){r=new RegExp('\\[ugsxx_'+i+'\\]','g');s=s.replace(r,'['+newChords[i]+']');}
_ele.cpmSource.value=s;_this.run();};};
;ugsEditorPlus.songUi=new function(){var trySet=function(id,value){var hasValue=value&&(value.length>0);var h=document.getElementById(id);if(!h){return;}
h.innerHTML=hasValue?value:"";h.style.display=hasValue?'block':'none';};this.update=function(song){var h=document.getElementById('songTitle');h.innerHTML=(song.title.length>0)?song.title:'Untitled-Song';trySet('songArtist',song.artist);trySet('songAlbum',song.album);trySet('songSubtitle',song.st);h=document.getElementById('songMeta');if(!song.ugsMeta||(song.ugsMeta.length<1)){h.style.display='none';}
else{var s='';for(var i=0;i<song.ugsMeta.length;i++){s+='<p>'+song.ugsMeta[i]+'</p>';}
h.innerHTML=s;h.style.display='block';}};};
;ugsEditorPlus.styles=new function(){var _sheet=null;this.Rules=null;this.getSheet=function(title){_sheet=_getSheet(title);this.Rules=getRules();return this;};var _getSheet=function(title){for(var i=0;i<document.styleSheets.length;i++){if(document.styleSheets[i].title==title){return document.styleSheets[i];break;}}
return null;};var getRules=function(){if(_sheet==null){return[];}
return _sheet.cssRules?_sheet.cssRules:_sheet.rules;};this.Find=function(selector){selector=selector.toLowerCase();for(var i=0;i<this.Rules.length;i++){if(!this.Rules[i].selectorText){continue;}
if(this.Rules[i].selectorText.toLowerCase()==selector){return this.Rules[i];break;}}
return null;};};
;ugsEditorPlus.optionsDlg=new function(){var run=null;var _ele=null;var _inputIgnoreList=null;var _chkIgnore=null;this.init=function(actionsController,elements){run=actionsController.run;_ele=elements;document.getElementById('pageWidth').onchange=function(){doSetWidth(this.value);};document.getElementById('chkEnclosures').onclick=function(){doSetEnclosure(!this.checked);};_inputIgnoreList=document.getElementById('commonChordList');_inputIgnoreList.value=ukeGeeks.settings.commonChords.join(", ");_inputIgnoreList.onchange=function(){doSetCommon();};_chkIgnore=document.getElementById('chkIgnoreCommon');_chkIgnore.onclick=function(){doIgnoreChkClk();};};var doSetWidth=function(value){var opts=['letter','a4','screen'];for(var i=0;i<opts.length;i++){ukeGeeks.toolsLite.removeClass(_ele.docBody,'pageWidth_'+opts[i]);}
ukeGeeks.toolsLite.addClass(_ele.docBody,'pageWidth_'+value);};var doSetEnclosure=function(isVisible){ukeGeeks.settings.opts.retainBrackets=isVisible;run();};var doIgnoreChkClk=function(){ukeGeeks.settings.opts.ignoreCommonChords=_chkIgnore.checked;run();};var doSetCommon=function(){var inputList=_inputIgnoreList.value.split(/[ ,]+/);var chordList=[];for(var i=0;i<inputList.length;i++){var c=ukeGeeks.toolsLite.trim(inputList[i]);if(c.length>0){chordList.push(c);}};ukeGeeks.settings.commonChords=chordList;if(_chkIgnore.checked){run();}};};
;var ugsEditorPlus=window.ugsEditorPlus||{};ugsEditorPlus.reformat=new function(){var _this=this;var _hasChords=false;var enums={lineTypes:{blank:0,chords:1,lyrics:2,tabs:3}}
var lineObj=function(){this.source='';this.wordCount=0;this.spaceCount=0;this.words=[];this.chordCount=0;this.lineType=enums.lineTypes.blank;};var re={words:/\b(\S+)\b/gi,spaces:/(\s+)/g,leadingSpace:/(^\s+)/,chordNames:/\b[A-G][#b]?(m|m6|m7|m9|dim|dim7|maj7|sus2|sus4|aug|6|7|9|add9)?\b/,chrdBlock:/\b(\S+\s*)/g,tabs:/^\s*(\|{0,2}[A-Gb]?\|{0,2}[-x0-9|:]{4,})/};this.run=function(text){_hasChords=false;var lines=read(text);return merge(lines);};this.hasChords=function(){return _hasChords;};var read=function(text){var lineAry=[];text=text.replace(' ','    ');var lines=text.split('\n');for(var i=0;i<lines.length;i++){var words=lines[i].match(re.words);var l=new lineObj;l.source=lines[i];if((words!=null)&&(words.length>0)){l.wordCount=words.length;l.words=words;l.chordCount=countChords(words);}
var spaces=lines[i].match(re.spaces);if((spaces!=null)&&(spaces.length>0)){l.spaceCount=spaces.length;}
l.lineType=toLineType(l);lineAry.push(l);}
return lineAry;};var toLineType=function(line){if((line.spaceCount+line.wordCount)<1){return enums.lineTypes.blank;}
var tabs=line.source.match(re.tabs);if(tabs!=null){return enums.lineTypes.tabs;}
var t=enums.lineTypes.lyrics;if((line.chordCount>0)&&(line.wordCount==line.chordCount)){t=enums.lineTypes.chords;_hasChords=true;}
return t;};var countChords=function(words){var count=0;for(var i=0;i<words.length;i++){if(words[i].match(re.chordNames)){count++;}}
return count;};var merge=function(lines){var s='';var thisLine,nextLine;for(var i=0;i<lines.length;){thisLine=lines[i];nextLine=lines[i+1];i++;if(!nextLine||(thisLine.lineType==enums.lineTypes.blank)){s+=thisLine.source+'\n';continue;}
if((thisLine.lineType==enums.lineTypes.tabs)&&isTabBlock(lines,i)){s+='{start_of_tab}\n'
+thisLine.source.replace(re.leadingSpace,'')+'\n'
+nextLine.source.replace(re.leadingSpace,'')+'\n'
+lines[i+1].source.replace(re.leadingSpace,'')+'\n'
+lines[i+2].source.replace(re.leadingSpace,'')+'\n'
+'{end_of_tab}\n';i+=3;continue;}
if((thisLine.lineType!=enums.lineTypes.chords)||(nextLine.lineType!=enums.lineTypes.lyrics)){s+=(thisLine.lineType==enums.lineTypes.chords)?wrapChords(thisLine.source)+'\n':thisLine.source+'\n';continue;}
i++;s+=mergeLines(thisLine.source,nextLine.source)+'\n';}
return s;};var isTabBlock=function(lines,index){if(index+3>=lines.length){return false;}
for(var i=index;i<index+3;i++){if(lines[i].lineType!=enums.lineTypes.tabs){return false;}}
return true;};var mergeLines=function(chordLine,lyricsLine){while(lyricsLine.length<chordLine.length){lyricsLine+=' ';}
var s='';var blocks=chordLine.match(re.chrdBlock);var lead=chordLine.match(re.leadingSpace);var offset=0;if(lead){s+=lyricsLine.substr(offset,lead[0].length);offset=lead[0].length;}
for(var j=0;j<blocks.length;j++){s+='['+blocks[j].replace(re.spaces,'')+']'+lyricsLine.substr(offset,blocks[j].length);offset+=blocks[j].length;}
if(offset<lyricsLine.length){s+=lyricsLine.substr(offset,lyricsLine.length);}
return s;};var wrapChords=function(chordLine){var chords=chordLine.replace(re.spaces,' ').split(' ');var s='';for(var i=0;i<chords.length;i++){if(chords[i].length>0){s+='['+chords[i]+'] ';}}
return s;};};
;ugsEditorPlus.autoReformat=new function(){var _this=this;var _elements;var _formatted;var _isDisabled=false;this.run=function(elements){if(_isDisabled){return;}
_elements=elements;_elements.reformatTextBox=document.getElementById('reformatSource');_elements.reformatDlg=document.getElementById('reformatDlg');document.getElementById('reformatYesBtn').onclick=function(){doOk();return false;};document.getElementById('reformatNoBtn').onclick=function(){doClose();return false;};var chk=document.getElementById('reformatDisable');chk.checked=false;chk.onclick=function(){doDisable(this.checked);};runNow();};var doOk=function(){_elements.cpmSource.value=_formatted;doClose();ugsEditorPlus.actions.run(true);};var doClose=function(){ukeGeeks.toolsLite.addClass(_elements.reformatDlg,'isHidden');};var doDisable=function(isDisabled){_isDisabled=isDisabled;};var runNow=function(){_formatted=ugsEditorPlus.reformat.run(_elements.cpmSource.value);_elements.reformatTextBox.innerHTML=_formatted;if(!ugsEditorPlus.reformat.hasChords()){return;}
ukeGeeks.toolsLite.removeClass(_elements.reformatDlg,'isHidden');};}
;ugsEditorPlus.menus=new function(){var _menuItems;var _topBtnUl=null;var _topBtnHref='';var _subBtnHref='';var _prevValues={'#layout':'#left','#placement':'#above','#tuning':'#soprano','#zoom':'#prct_100','#transpose':'#up_0','#colors':'#normal'};this.init=function(){_menuItems=document.getElementById('ugsAppToolbar').getElementsByTagName('ul')[0].children;addSizeOptions();attachClicks();};var attachClicks=function(){for(var i=0;i<_menuItems.length;i++){var topBtn=_menuItems[i].getElementsByTagName('a')[0];var ul=_menuItems[i].getElementsByTagName('ul');if(ul.length<1){topBtn.onclick=function(){closeAll();return false;};continue;}
topBtn.onclick=function(){switchActiveMenu(this);return false;};var items=_menuItems[i].getElementsByTagName('li');for(var j=0;j<items.length;j++){var subBtn=items[j].getElementsByTagName('a')[0];subBtn.onclick=function(){subBtnClick(this);return false;};}}};var switchActiveMenu=function(ele){var isOpen=ukeGeeks.toolsLite.hasClass(ele.parentNode,'active');closeAll();if(isOpen){return;}
ukeGeeks.toolsLite.addClass(ele.parentNode,'active');_topBtnUl=ele.parentNode.getElementsByTagName('ul')[0];_topBtnHref=getHref(ele);};var subBtnClick=function(ele){closeAll();_subBtnHref=getHref(ele);if(_prevValues[_topBtnHref]==_subBtnHref){return;}
for(var i=0;i<_topBtnUl.children.length;i++){ukeGeeks.toolsLite.removeClass(_topBtnUl.children[i],'checked');}
ukeGeeks.toolsLite.addClass(ele.parentNode,'checked');ugsEditorPlus.actions.doClick(_topBtnHref,_subBtnHref);_prevValues[_topBtnHref]=_subBtnHref;};var getHref=function(ele){return'#'+ele.getAttribute('href').split('#')[1];};var closeAll=function(){for(var i=0;i<_menuItems.length;i++){ukeGeeks.toolsLite.removeClass(_menuItems[i],'active');}};var addSizeOptions=function(){var s='';var size=0;for(var i=50;i<120;i+=5){size++;var selected=(i==100)?'class="checked"':'';var pt='';switch(i){case 50:case 60:case 75:case 85:case 90:case 100:case 115:pt='<em>'+Math.round((i/100)*12)+'pt</em>';break;}
s+='<li '+selected+'><a href="#prct_'+i+'">'+i+'%'+pt+'</a></li>';}
var element=document.getElementById('printScale');element.innerHTML=s;};this.resetTranspose=function(chord){var ul=document.getElementById('transposeOptions');var items=ul.getElementsByTagName('li');var sample;var steps=-6;_prevValues['#transpose']='#up_0';for(i=0;i<items.length;i++){ukeGeeks.toolsLite.removeClass(items[i],'checked');sample=(chord.length<1)?'':ukeGeeks.transpose.shift(chord,steps);items[i].getElementsByTagName('em')[0].innerHTML=sample;if(steps==0){ukeGeeks.toolsLite.addClass(items[i],'checked');}
steps++;}};};