/**
 * This library implments the UkeGeeks Scriptasaurus Song-a-matic editor functions, bridging the page UI and scriptasaurus methods.
 * @module  ugsEditorPlus
 * @namespace  ugsEditorPlus
 * @class ugsEditorPlus
 */
var ugsEditorPlus = (function() {
	/**
	 * attach public members to this object
	 * @property _public
	 * @type JsonObject
	 */
	var _public = {};

	/**
	 * attaches event handlers, preps variables, and runs UGS
	 * @method init
	 * @private
	 * @param isLegacyIe {bool} pre-IE 9 versions
	 */
	var init = function(isLegacyIe) {
		// ukeGeeks.tumblr.opts.diagramResizeTo = 1;
		ukeGeeks.settings.opts.retainBrackets = false;

		ukeGeeks.scriptasaurus.init(isLegacyIe);

		ugsEditorPlus.actions.init(isLegacyIe);
		ugsEditorPlus.topMenus.init();
		ugsEditorPlus.submenuUi.init(ugsEditorPlus.actions.doAction);
		ugsEditorPlus.optionsDlg.init(ugsEditorPlus.actions.doAction);
		ugsEditorPlus.chordBuilder.init();
		ugsEditorPlus.actions.run();
	};

	/**
	 * wraps the private Init method for modern browsers
	 * @method attach
	 * @public
	 */
	_public.attach = function() {
		init(false);
	};

	/**
	 * wraps the private Init method, required for Legacy Internet Exploere (pre-9)
	 * @method attach
	 * @public
	 */
	_public.attachIe = function() {
		init(true);
	};

	// ---------------------------------------
	// return public interface "JSON handle"
	// ---------------------------------------
	return _public;

}());
;ugsEditorPlus.actions=function(){var b={},c={},a=null,g=null,f=[],l=/^([A-G][#b]?)(m|m6|7|m7|dim|maj7|6|sus2|sus4|aug|9)?$/,n={placement:"above",transpose:"up_0"};b.init=function(a){c={songText:document.getElementById("ukeSongText"),songContainer:document.getElementById("ukeSongContainer"),cpmSource:document.getElementById("chordProSource"),scalableArea:document.getElementById("scalablePrintArea")}};b.doAction=function(a,m){switch(a){case "zoomFonts":var k=parseFloat(m,10);c.scalableArea.style.fontSize=
k+"pt";break;case "zoomDiagrams":var k=parseInt(m,10)/100,h=Math.round(225*k),d=ugsEditorPlus.styles.getSheet("ugsEditorCss"),e=d.Find(".scalablePrintArea .ugs-diagrams-wrap canvas");e.style.width=Math.round(k*ukeGeeks.settings.fretBox.width)+"px";e.style.height=Math.round(k*ukeGeeks.settings.fretBox.height)+"px";e=d.Find(".scalablePrintArea .ugs-diagrams-wrap");e.style.width=h+"px";e=d.Find(".scalablePrintArea .ugs-source-wrap");e.style.marginLeft=25+h+"px";break;case "layout":$("body").toggleClass("diagramsOnTop",
"top"==m).toggleClass("diagramsOnSide","left"==m).toggleClass("ugsHideDiagrams","none"==m);break;case "placement":ukeGeeks.toolsLite.setClass(c.songContainer,"ugsInline","inline"==m);(k="miniDiagrams"==m)||ukeGeeks.toolsLite.removeClass(c.songContainer,"ugsInlineDiagrams");k||"miniDiagrams"==n.placement?(ukeGeeks.settings.inlineDiagrams=k,b.run()):k||"miniDiagrams"==n.placement||ukeGeeks.overlapFixer.Fix(c.songText);n.placement=m;break;case "tuning":k=ukeGeeks.definitions.instrument.sopranoUke;h=
"Standard <strong>GCEA</strong> Soprano Ukulele";"baritone"==m&&(k=ukeGeeks.definitions.instrument.baritoneUke,h="Standard <strong>DGBE</strong> Baritone Ukulele");$("#footTuningInfo").html(h);ukeGeeks.scriptasaurus.setTuningOffset(k);b.run();break;case "colors":ugsEditorPlus.themes.set(m);b.run();break;case "transpose":k="u"==m[0]?1:-1;h=parseInt(m[m.length-1],10);var k=k*h,e=[],h="",p;for(p=0;p<f.length;p++)l.test(f[p])?e.push(f[p]):h+=f[p]+", ";if(!(0<h.length)||confirm("Sorry, but some of your chords can't be transposed:\n"+
h+"\n\nDo you want to continue anyway?")){var q=ukeGeeks.transpose.shiftChords(e,k),h=g;for(p=0;p<e.length;p++)d=RegExp("\\["+e[p]+"\\]","g"),h=h.replace(d,"[ugsxx_"+p+"]");for(p=0;p<q.length;p++)d=RegExp("\\[ugsxx_"+p+"\\]","g"),h=h.replace(d,"["+q[p]+"]");d=/^\s*\{\s*(key|k)\s*:\s*(\S*?)\s*\}\s*$/im;d.test(h)&&(e=h.match(d),p=e[2],""!==p&&l.test(p)&&(h=h.replace(d,e[0].replace(p,ukeGeeks.transpose.shift(p,k)))));c.cpmSource.value=h;b.run()}break;case "paper":k=["letter","a4","screen"];h=$("body");
for(d=0;d<k.length;d++)h.removeClass("pageWidth_"+k[d]);h.addClass("pageWidth_"+m);break;case "showEnclosures":ukeGeeks.settings.opts.retainBrackets=m;b.run();break;case "hideCommonChords":ukeGeeks.settings.opts.ignoreCommonChords=m;b.run();break;case "setCommonChords":k=m.split(/[ ,]+/);h=[];for(d=0;d<k.length;d++)e=ukeGeeks.toolsLite.trim(k[d]),0<e.length&&h.push(e);ukeGeeks.settings.commonChords=h;ukeGeeks.settings.opts.ignoreCommonChords&&b.run();break;case "update":b.run(!0);break;default:console.log("Unrecognized "+
a+" > "+m)}};b.run=function(b){b=0<arguments.length&&b;c.songText.innerHTML="<pre>"+c.cpmSource.value+"</pre>";a=ukeGeeks.scriptasaurus.run();1>a.chords.length&&ugsEditorPlus.autoReformat.run(c);if(a&&(ugsEditorPlus.songUi.update(a),b||null===g)){g=c.cpmSource.value;f=a.chords;var m=""!==a.key?a.key:1>a.chords.length?"":a.chords[0],k=document.getElementById("transposeOptions").getElementsByTagName("li"),h,d=-6;n.transpose="up_0";ugsEditorPlus.submenuUi.resetTransposeLabel();for(var e=0;e<k.length;e++)ukeGeeks.toolsLite.removeClass(k[e],
"checked"),h=1>m.length?"":ukeGeeks.transpose.shift(m,d),k[e].getElementsByTagName("em")[0].innerHTML=h,0===d&&ukeGeeks.toolsLite.addClass(k[e],"checked"),d++}};return b}();
ugsEditorPlus.songUi=function(){var b={},c=function(a,c){var b=c&&0<c.length,l=document.getElementById(a);l&&(l.innerHTML=b?c:"",l.style.display=b?"block":"none")};b.update=function(a){var b=document.getElementById("songTitle");b.innerHTML=0<a.title.length?a.title:"Untitled-Song";c("songArtist",a.artist);c("songAlbum",a.album);c("songSubtitle",a.st);b=document.getElementById("songMeta");if(!a.ugsMeta||1>a.ugsMeta.length)b.style.display="none";else{for(var f="",l=0;l<a.ugsMeta.length;l++)f+="<p>"+
a.ugsMeta[l]+"</p>";b.innerHTML=f;b.style.display="block"}};return b}();
ugsEditorPlus.styles=new function(){var b=null;this.Rules=null;this.getSheet=function(c){a:{for(var a=0;a<document.styleSheets.length;a++)if(document.styleSheets[a].title==c){b=document.styleSheets[a];break a}b=null}c=null==b?[]:b.cssRules?b.cssRules:b.rules;this.Rules=c;return this};this.Find=function(b){b=b.toLowerCase();for(var a=0;a<this.Rules.length;a++)if(this.Rules[a].selectorText&&this.Rules[a].selectorText.toLowerCase()==b)return this.Rules[a];return null}};
ugsEditorPlus.themes=new function(){var b={normal:{name:"Normal (white paper)",selectText:"Normal colors (white paper)",description:"Simple, legible text on white paper",song:{fretLines:"#003366",dots:"#ff0000",dotText:"#ffffff",text:"#000000",fretText:"#4a4a4a"},tabs:{lines:"#999999",dots:"#eaeaea",text:"#000000"}},reversed:{name:"Reversed for projectors",selectText:"Reversed colors (for projectors)",description:"Light text on dark background",song:{fretLines:"#365F70",dots:"#FDD96F",dotText:"#000000",
text:"#FF6040",fretText:"#999999"},tabs:{lines:"#365F70",dots:"#FDD96F",text:"#000000"}},frosty:{name:"Frostcicle",selectText:"Frostcicle (cool blue)",description:"Brrrr... icy cool blues",song:{fretLines:"#66B4CC",dots:"#332335",dotText:"#9FE1F9",text:"#0896FE",fretText:"#E3D8BA"},tabs:{lines:"#6699FF",dots:"#EFFCF9",text:"#00558E"}},jellyBean:{name:"Jelly Beans",selectText:"Jelly Beans (vibrant)",description:"Sugary, vibrant bowl of jelly beans!",song:{fretLines:"#49BC45",dots:"#FF9417",dotText:"#FCF49F",
text:"#D20070",fretText:"#4a4a4a"},tabs:{lines:"#6699FF",dots:"#FFF9BA",text:"#75003E"}},justBlack:{name:"Just Black",selectText:"Black (for laser printers)",description:"No color, but black, best for B&W laser printers",song:{fretLines:"#cccccc",dots:"#000000",dotText:"#ffffff",text:"#000000",fretText:"#000000"},tabs:{lines:"#cccccc",dots:"#000000",text:"#ffffff"}},krampus:{name:"Gruss vom Krampus",selectText:"Krampus (Ye Olde Christmas)",description:"Seasons Greetin's, Happy Holidays, Merry Christmas, Krampus Nichte!",
song:{fretLines:"#929867",dots:"#A22C27",dotText:"#EBD592",text:"#4F2621",fretText:"#4a4a4a"},tabs:{lines:"#B69C01",dots:"#E1EEC8",text:"#75003E"}},western:{name:"Out West",selectText:"Out West (dust country)",description:"Dusty Honky Tonk/Country/Western look",song:{fretLines:"#B5A679",dots:"#CF8300",dotText:"#ffffff",text:"#386571",fretText:"#4a4a4a"},tabs:{lines:"#697665",dots:"#F1E3C5",text:"#632424"}},pumpkin:{name:"Pumpkin Pie",selectText:"Pumpkin Pie (fall colors)",description:"Fall 'n Halloween 'n Jack o'Lantern 'n Thanksgiving Fun",
song:{fretLines:"#8E9A6C",dots:"#DA6328",dotText:"#FFEE4A",text:"#68391D",fretText:"#B14623"},tabs:{lines:"#BED379",dots:"#FFF4D8",text:"#B14623"}},notebook:{name:"Rock Notebook",selectText:"Rock Notebook (marker)",description:"A strong, hand-scrawled, and edgily unreliable look",song:{fretLines:"#747CAD",dots:"#1C0866",dotText:"#ffffff",text:"#B22000",fretText:"#A4A0B2"},tabs:{lines:"#A4A0B2",dots:"#F1E3C5",text:"#2E2ECC"}},zombie:{name:"Zombies!!!",selectText:"Zombies!!!",description:"Blood 'n gore for Halloween",
song:{fretLines:"#9EB036",dots:"#E52501",dotText:"#FEDA79",text:"#798666",fretText:"#B14623"},tabs:{lines:"#602749",dots:"#F7F9EA",text:"#4F5F3E"}}};this.getDescription=function(c){return b[c].selectText};this.loadList=function(c){var a="",g;for(g in b)b.hasOwnProperty(g)&&(a+='<li class="'+("normal"==g?"checked":"")+'"><a href="#'+g+'" title="'+b[g].description+'">'+b[g].name+"</a></li>");$(c).html(a)};this.set=function(c){var a=$("body"),g;for(g in b)b.hasOwnProperty(g)&&a.removeClass("theme-"+
g);a.addClass("theme-"+c);c=b[c];ukeGeeks.settings.colors=c.song;ukeGeeks.settings.tabs.lineColor=c.tabs.lines;ukeGeeks.settings.tabs.dotColor=c.tabs.dots;ukeGeeks.settings.tabs.textColor=c.tabs.text}};
ugsEditorPlus.optionsDlg=function(){var b={},c=null,a,g,f;b.init=function(b){c=b;a=document.getElementById("commonChordList");g=document.getElementById("chkIgnoreCommon");f=document.getElementById("chkEnclosures");a.value=ukeGeeks.settings.commonChords.join(", ");g.checked=ukeGeeks.settings.opts.ignoreCommonChords;f.checked=!ukeGeeks.settings.opts.retainBrackets;document.getElementById("updateBtn").onclick=function(){c("update",null);return!1};f.onclick=function(){c("showEnclosures",!this.checked)};
a.onchange=function(){c("setCommonChords",a.value)};g.onclick=function(){c("hideCommonChords",this.checked)};$(".checkboxBlock label, input[type=checkbox]").click(function(a){a.stopPropagation()});$(".overlay").draggable({handle:"hgroup"})};return b}();var ugsEditorPlus=window.ugsEditorPlus||{};
ugsEditorPlus.reformat=new function(){var b=!1,c=function(){this.source="";this.spaceCount=this.wordCount=0;this.words=[];this.lineType=this.chordCount=0},a=/\b(\S+)\b/gi,g=/(\s+)/g,f=/(^\s+)/,l=/\b[A-G][#b]?(m|m6|m7|m9|dim|dim7|maj7|sus2|sus4|aug|6|7|9|add9|7sus4)?\b/,n=/\b(\S+\s*)/g,r=/^\s*(\|{0,2}[A-Gb]?\|{0,2}[-x0-9|:]{4,})/;this.run=function(m){b=!1;var k=[];m=m.replace("\t","    ");m=m.split("\n");for(var h=0;h<m.length;h++){var d=m[h].match(a),e=new c;e.source=m[h];if(null!=d&&0<d.length){e.wordCount=
d.length;e.words=d;for(var p=e,q=0,s=0;s<d.length;s++)d[s].match(l)&&q++;p.chordCount=q}p=m[h].match(g);null!=p&&0<p.length&&(e.spaceCount=p.length);p=e;d=e;1>d.spaceCount+d.wordCount?d=0:null!=d.source.match(r)?d=3:(q=2,0<d.chordCount&&d.wordCount==d.chordCount&&(q=1,b=!0),d=q);p.lineType=d;k.push(e)}h="";for(m=0;m<k.length;)if(e=k[m],p=k[m+1],m++,p&&0!=e.lineType){if(d=3==e.lineType)a:if(m+3>=k.length)d=!1;else{for(d=m;d<m+3;d++)if(3!=k[d].lineType){d=!1;break a}d=!0}if(d)h+="{start_of_tab}\n"+
e.source.replace(f,"")+"\n"+p.source.replace(f,"")+"\n"+k[m+1].source.replace(f,"")+"\n"+k[m+2].source.replace(f,"")+"\n{end_of_tab}\n",m+=3;else if(1!=e.lineType||2!=p.lineType){if(1==e.lineType){e=e.source.replace(g," ").split(" ");p="";for(d=0;d<e.length;d++)0<e[d].length&&(p+="["+e[d]+"] ");e=p+"\n"}else e=e.source+"\n";h+=e}else{m++;q=e.source;for(e=p.source;e.length<q.length;)e+=" ";p="";d=q.match(n);s=q.match(f);q=0;s&&(p+=e.substr(q,s[0].length),q=s[0].length);for(s=0;s<d.length;s++)p+="["+
d[s].replace(g,"")+"]"+e.substr(q,d[s].length),q+=d[s].length;q<e.length&&(p+=e.substr(q,e.length));h+=p+"\n"}}else h+=e.source+"\n";return h};this.hasChords=function(){return b}};
ugsEditorPlus.autoReformat=function(){var b={},c={},a,g=!1;b.run=function(b){g||(c=b,c.reformatTextBox=document.getElementById("reformatSource"),c.reformatDlg=document.getElementById("reformatDlg"),document.getElementById("reformatYesBtn").onclick=function(){c.cpmSource.value=a;f();ugsEditorPlus.actions.run(!0);return!1},document.getElementById("reformatNoBtn").onclick=function(){f();return!1},b=document.getElementById("reformatDisable"),b.checked=!1,b.onclick=function(){g=this.checked},a=ugsEditorPlus.reformat.run(c.cpmSource.value),
c.reformatTextBox.innerHTML=a,ugsEditorPlus.reformat.hasChords()&&ukeGeeks.toolsLite.removeClass(c.reformatDlg,"isHidden"))};var f=function(){ukeGeeks.toolsLite.addClass(c.reformatDlg,"isHidden")};return b}();
ugsEditorPlus.topMenus=function(){var b={init:function(){$("#ugsAppToolbar > ul li").not("[data-dialog]").children("a").click(c);$(".showOptionsBox a").click(n);$("#ugsAppToolbar > ul li[data-dialog]").click(g);$(".closeBtn").click(f);$(".resizeBtn").click(l)}},c=function(){var b=$(this).parent(),c=b.hasClass("active");a();c||b.addClass("active")},a=function(){$("#ugsAppToolbar > ul > li").removeClass("active")},g=function(a){a=$(this).data("dialog");$("#"+a).fadeIn();return!1},f=function(a){$(this).parents(".overlay").fadeOut();
return!1},l=function(a){a=$(this).parents(".overlay");ugsEditorPlus.resize.toggle(a);return!1},n=function(a){a=$(this).attr("href");$(".arrowBox").not(a).hide();a=$(a);a.find("dd").hide();a.fadeToggle();ugsEditorPlus.submenuUi.reset(a);return!1};b.makeAllInactive=a;return b}();
ugsEditorPlus.submenuUi=function(){var b={},c=null,a=null;b.init=function(b){a=b;ugsEditorPlus.themes.loadList("#colorPicker .pseudoSelect");$(".enablePseudoSelects label").click(f);$(".pseudoSelect li").click(g);$("body").bind("click",r);$(".arrowBox").click(n)};var g=function(b){b=$(this);var d;d=b.children().attr("href");d="#"==d[0]?d.substr(1):d;var m=b.parents("dd"),p=m.attr("id"),m=m.data("action");$("#"+p).hide().find("li").removeClass("checked");b.addClass("checked");l(this,!1);c=null;$("label[for="+
p+"] span").text(k(m,d,b));$("label[for="+p+"]").parents("dt").removeClass("active");a(m,d);return!1},f=function(a){a=$(this);var b=a.attr("for");a.closest("dl").children("dt").removeClass("active");a.closest("dt").addClass("active");$("#"+b).show();l(this,!0);null!=c&&$("#"+c.id).hide();c=null!=c&&c.id==b?null:{id:b};return!1};b.reset=function(a){a.find("dt").removeClass("active");a.find(".event-userSelecting").removeClass("event-userSelecting")};var l=function(a,b){$(a).parents(".enablePseudoSelects").toggleClass("event-userSelecting",
b)},n=function(a){if(!$(a.target).is("a"))return $(this).find("dd").hide(),c=null,!1},r=function(a){$(".arrowBox").fadeOut(270);ugsEditorPlus.topMenus.makeAllInactive()},m={zoomDiagrams:["Tiny","Small","Medium","Large","Stupid Large"],layout:["Reference diagrams on left","Reference diagrams at top","No reference diagrams"],placement:["Chord names inline with lyrics","Chord names above lyrics","Names & diagrams above lyrics"],tuning:["Soprano (GCEA) tuning","Baritone (DBEA) tuning"]},k=function(a,
b,k){var c=k.index();switch(a){case "paper":return"Width "+k.text();case "zoomFonts":return"Font size "+b+"pt";case "zoomDiagrams":return m.zoomDiagrams[c]+" diagrams";case "colors":return ugsEditorPlus.themes.getDescription(b);case "transpose":return"up_0"==b?"Original key":k.text().replace(" ",' steps - "')+'"';default:return m[a][c]}};b.resetTransposeLabel=function(){$("label[for=transposePicker] span").text("Original key")};return b}();
ugsEditorPlus.newSong=function(){var b={},c=!1,a="";b.init=function(b){a=b;$("#newSongBtn").click(function(a){a=$("#songTitle");var b=a.val().trim();a.val(b);a=2<b.length;f(!a,"Song's title is required<br/><em>(you may change it later, must be at least 2 characters)</em>");a&&g()});$("#openNewDlgBtn").click(function(a){$("#songTitle, #songArtist").val("");$("#newSongForm").fadeIn();$("#songTitle").focus()});$("#hideNewSongBtn").click(l);$("#newSongForm").bind("keydown",n);$spinner=$("#loadingSpinner");
$spinner.hide();$(document).ajaxStart(function(){$spinner.show();c=!0}).ajaxStop(function(){$spinner.hide();c=!1})};var g=function(){if(!c){var b={handler:"ugs_new",songTitle:$("#songTitle").val(),songArtist:$("#songArtist").val()};$.ajax({url:a,type:"POST",dataType:"json",data:JSON.stringify(b),success:function(a){f(a.HasErrors,a.Message);a.HasErrors||(document.location.href=a.ContinueUri)}})}},f=function(a,b){var k=$("#newSongForm .errorMessage");a?(k.show().html(b),$("#songTitle").focus()):k.hide()},
l=function(a){$("#newSongForm").fadeOut()},n=function(a){27==a.which&&l()};return b}();
ugsEditorPlus.updateSong=function(){var b={},c="",a="",g=!1;b.init=function(b,n){c=b;a=n;$("#saveBtn").click(function(a){f();return!1});$("#messageBox").hide();$(document).ajaxStart(function(){$("#sourceFeedback").hide().html();$("#messageBox").slideDown("fast");$("#loadingSpinner").show();g=!0}).ajaxStop(function(){$("#messageBox").delay(3E3).fadeOut("slow");g=!1})};var f=function(){if(!g){$("#sourceFeedback").show();var b={handler:"ugs_update_81jr",filename:a,song:$("#chordProSource").val()};$.ajax({url:c,
type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(b),success:function(a){a=a.Message;$("#loadingSpinner").hide();$("#sourceFeedback").show().html(a)}})}};return b}();
ugsEditorPlus.typeahead=function(){var b={},c=[],a={},g="",f,l=[],n=/\s{2,}/g,r=/([^a-z0-9]+)/gi,m=/['`\u2019-]/g,k=function(){$("li").each(function(b){var k=$(this);b=h(k.text());var d=k.children("a").attr("href"),m=d.toLowerCase(),k=k.children("a").html(),k=k.replace('<strong class="','<span class="bigger ').replace("</strong>","</span>");a[m]={html:k,searchText:b,code:m,href:d};c.push(m)})},h=function(a){return a.toLowerCase().replace(m,"").replace(r," ").replace(n," ").trim()},d=function(a,b){g=
h(a);l=g.split(" ");for(var k="",d=0;d<l.length;d++)l[d]=l[d].trim(),0<l[d].length&&(k+=(0<k.length?"|":"")+l[d]);f=RegExp("("+k+")","gi");b(c)},e=function(b){window.location=a[b].href;return a[b].searchText},p=function(b){b=a[b];for(var k=0;k<l.length;k++)if(-1==b.searchText.indexOf(l[k]))return!1;return!0},q=function(b){return b.sort(function(b,k){return a[b].searchText>a[k].searchText})},s=function(b){b=$("<div/>").html(a[b].html);$("em, .bigger",b).each(function(a){a=$(this);var b=a.html();a.html(b.replace(f,
"<strong>$1</strong>"))});return b.html()};b.initialize=function(){k();$("#quickSearch").typeahead({source:d,updater:e,matcher:p,sorter:q,highlighter:s,minLength:2,items:50}).val("").focus()};return b};
ugsEditorPlus.resize=function(){var b={},c=null,a=null,g=null,f=null,l=!1,n=!1,r=function(b){c=$(b);$("body").append('<div id="aceHeader"><button class="aceSideBtn" title="Show options &amp; help"><span></span><span></span><span></span></button><strong>Edit Song</strong><a href="#exit-fullscreen">Exit fullscreen</a></div><div id="aceEditor"></div><div id="aceHelp"></div>');a=$("#aceEditor");a.fadeOut(1);g=$("#aceHelp");$("#aceHeader a").click(function(a){a.preventDefault();e()});$("#aceHeader button").click(m)},
m=function(a){a.preventDefault();k(!n)},k=function(b){(n=b)?(g.animate({left:0},400),a.animate({left:"350px"},400)):(g.animate({left:"-350px"},400),a.animate({left:0},400))},h=function(){l=!0;$("html").addClass("aceEditorActive");$(".overlay").fadeOut(300);null===f?LazyLoad.js("/js/ace/ace.js",function(){f=ace.edit("aceEditor");f.setTheme("ace/theme/idle_fingers");f.getSession().setMode("ace/mode/chordpro");f.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0});f.completers=[ugsAce.chordCompleter];
d();g.html(ugsAce.helpHtml)}):d()},d=function(){a.fadeIn(550);f.setValue($("#chordProSource").val());f.gotoLine(1);g.fadeIn(1)},e=function(){l=!1;c.show();a.fadeOut(550);g.fadeOut(550);null!==f&&$("#chordProSource").val(f.getValue());$("html").removeClass("aceEditorActive");k(!1)};b.toggle=function(a){null===c&&r(a);l?e():h();return!1};return b}();
ugsEditorPlus.chordBuilder=function(){var b={},c=null;b.init=function(){var b=$(".fingerToolImage").css("background-image");ugsChordBuilder.settings.cursor.imageUri=b.replace(/url\("(.*)hand.png"\)/i,"$1hand-cursor.png");c=new ugsChordBuilder.editorUi;c.init();$("#cdBldOpenBtn").click(a)};var a=function(a){a.preventDefault();c.reload();a=$(this).data("dialog");$("#"+a).fadeIn()};return b}();var ugsChordBuilder=window.ugsChordBuilder||{};
ugsChordBuilder.entities={BoundingBox:function(b,c){this.x=b?b.x:0;this.y=b?b.y:0;this.width=c?c.width:1;this.height=c?c.height:1},Dot:function(b,c,a){this.string=b;this.fret=c?c:0;this.finger=a?a:0},Position:function(b,c){this.x=b?b:0;this.y=c?c:0}};
ugsChordBuilder.settings=function(){var b=ugsChordBuilder.entities,c={x:75,y:75},a={numFrets:5,maxFret:16,stringNames:["G","C","E","A"],strokeWidth:4,strokeColor:"#8F8569",fretSpace:35,stringSpace:30},g=function(){return{height:a.fretSpace,width:a.stringSpace}};return{anchorPos:c,cursor:{fillColor:"rgba(220, 216, 73, 0.35)",strokeWidth:1,strokeColor:"#AAB444",radius:9,imageUri:"/img/editor/hand-cursor.png"},fretBoard:a,dot:{fillColor:"#F68014",radius:11,strokeWidth:2,strokeColor:"#D56333",fontWeight:"bold",
fontFamily:'Arial, "Helvetica Neue", Helvetica, Verdana, sans-serif',fontSize:16,fontColor:"#ffffff"},fretLabel:{fontFamily:'Arial, "Helvetica Neue", Helvetica, Verdana, sans-serif',fontSize:28,color:"#6A6A63",lightColor:"#EAEAE8"},stringLabel:{fontFamily:'Arial, "Helvetica Neue", Helvetica, Verdana, sans-serif',fontSize:34,color:"#DCD849"},chord:{nameMaxLength:20},targetDimensions:g,targetAnchorPos:function(){var f=g();return new b.Position(c.x-0.5*f.width,c.y-f.height-0.2*a.strokeWidth)},centerAnchor:function(b){c.x=
0.5*b.width-0.5*(a.stringNames.length-1)*a.stringSpace-a.strokeWidth;c.y=0.5*b.height-0.5*a.numFrets*a.stringSpace}}}();
ugsChordBuilder.tracking=new function(){var b=ugsChordBuilder.entities,c=ugsChordBuilder.settings,a=null;this.toDot=function(g){var f=new b.BoundingBox(g),l;a||(l=c.targetDimensions(),l.width*=c.fretBoard.stringNames.length,l.height*=c.fretBoard.numFrets+1,a=new b.BoundingBox(c.targetAnchorPos(),l));l=a;if(!(f.x<l.x+l.width&&f.x+f.width>l.x&&f.y<l.y+l.height&&f.y+f.height>l.y))return null;f=c.targetDimensions();return new b.Dot(Math.floor((g.x-l.x)/f.width),Math.floor((g.y-l.y)/f.height))}};
ugsChordBuilder.fretDots=new function(){var b=ugsChordBuilder.entities,c=ugsChordBuilder.settings.anchorPos,a=ugsChordBuilder.settings.fretBoard,g=ugsChordBuilder.settings.dot,f=[];this.getDots=function(){return f.slice()};this.slide=function(b){var c;a:{for(c=0;c<f.length;c++)if(1>f[c].fret+b||f[c].fret+b>a.numFrets){c=!1;break a}c=!0}if(!c)return!1;for(c=0;c<f.length;c++)f[c].fret+=b;return!0};this.toggleDot=function(a){if(0==a.fret)n(a.string);else{var b=l(a);0>b?f.push(a):f.splice(b,1)}};this.toggleFinger=
function(a,b){var k=l(a);if(0>k)return!1;f[k].finger=f[k].finger==b?0:b;return!0};this.reset=function(){for(var b=0;b<a.stringNames.length;b++)n(b)};var l=function(a){for(var b=f.length-1;0<=b;b--)if(f[b].string==a.string&&f[b].fret==a.fret)return b;return-1},n=function(a){for(var b=f.length-1;0<=b;b--)f[b].string==a&&f.splice(b,1)};this.draw=function(l){for(var m=f.length-1;0<=m;m--){var k;k=f[m];k=new b.Position(c.x+0.47*a.strokeWidth+k.string*a.stringSpace,c.y+0.47*a.strokeWidth+(k.fret-0.5)*a.fretSpace);
var h=l,d=k;h.beginPath();h.arc(d.x,d.y,g.radius,0,2*Math.PI,!1);h.fillStyle=g.fillColor;h.fill();h.lineWidth=g.strokeWidth;h.strokeStyle=g.strokeColor;h.stroke();0<f[m].finger&&(h=l,d=f[m].finger,h.font=g.fontWeight+" "+g.fontSize+"px "+g.fontFamily,h.textAlign="center",h.fillStyle=g.fontColor,h.fillText(d,k.x,k.y+0.3*g.fontSize))}}};
ugsChordBuilder.cursorCanvas=new function(){var b=ugsChordBuilder.settings.cursor,c=ugsChordBuilder.settings.dot,a=null,g=null,f=!1,l=!0,n=1,r={x:0,y:0};this.init=function(b){a=b;m()};var m=function(){g=new Image;g.onload=function(){f=!0};g.src=b.imageUri};this.setCursor=function(b,a){l=b;n=a};this.draw=function(k){var h=b.radius+b.strokeWidth;a.clearRect(r.x-h,r.y-h,h+50,h+60);!f||l?(a.beginPath(),a.arc(k.x,k.y,b.radius,0,2*Math.PI,!1),a.fillStyle=b.fillColor,a.fill(),a.lineWidth=b.strokeWidth,a.strokeStyle=
b.strokeColor,a.stroke()):(a.drawImage(g,k.x,k.y),a.font=c.fontWeight+" "+c.fontSize+"px "+c.fontFamily,a.textAlign="left",a.fillStyle="black",a.fillText(n,k.x+0.8*g.width,k.y+g.height));r=k}};
ugsChordBuilder.chordCanvas=new function(){var b=ugsChordBuilder.entities,c=ugsChordBuilder.settings.centerAnchor,a=ugsChordBuilder.settings.anchorPos,g=ugsChordBuilder.settings.fretLabel,f=ugsChordBuilder.settings.stringLabel,l=ugsChordBuilder.settings.fretBoard,n=null,r=null;this.init=function(b,a){n=b;r=a;c(r)};this.draw=function(c,k){n.clearRect(0,0,r.width,r.height);for(var h=new b.Position(a.x-0.3*g.fontSize,a.y+g.fontSize),d=1<k?g.color:g.lightColor,e=0;e<l.numFrets;e++){var p=k+e,q=h;n.font=
g.fontSize+"px "+g.fontFamily;n.textAlign="right";n.fillStyle=d;n.fillText(p,q.x,q.y);h.y+=l.fretSpace;d=g.lightColor}h=new b.Position(a.x+0.5*l.strokeWidth,a.y-0.25*g.fontSize);for(e=0;e<l.stringNames.length;e++)p=l.stringNames[e],d=h,n.font=f.fontSize+"px "+f.fontFamily,n.textAlign="center",n.fillStyle=f.color,n.fillText(p,d.x,d.y),h.x+=l.stringSpace;e=l.strokeWidth/2;p=l.numFrets*l.fretSpace;d=(l.stringNames.length-1)*l.stringSpace;n.beginPath();for(h=1;h<l.stringNames.length-1;h++)q=a.x+h*l.stringSpace+
e,n.moveTo(q,a.y+e),n.lineTo(q,a.y+p+e);for(h=1;h<l.numFrets;h++)q=a.y+h*l.fretSpace+e,n.moveTo(a.x+e,q),n.lineTo(a.x+d+e,q);n.rect(a.x+e,a.y+e,d,p);n.strokeStyle=l.strokeColor;n.lineWidth=l.strokeWidth;n.stroke();n.closePath();ugsChordBuilder.fretDots.draw(n)}};
ugsChordBuilder["export"]=new function(){var b=ugsChordBuilder.settings.fretBoard,c=ugsChordBuilder.settings.chord,a=null,g=function(b,a){this.string=b;this.dots=a?a:[]},f=function(){var a,c=[];for(a=1;a<=b.stringNames.length;a++)c.push(new g(a));var d=ugsChordBuilder.fretDots.getDots();for(a=c.length-1;0<=a;a--)for(var e=d.length-1;0<=e;e--)c[a].string==d[e].string+1&&c[a].dots.push(d[e]);return c},l=function(a){for(var b=0,c=900,e=a.length-1;0<=e;e--)a[e].fret>b&&(b=a[e].fret),a[e].fret<c&&(c=a[e].fret);
return{max:b,min:900>c?c:b}},n=function(b){return 0<b?a+b:0},r=function(a,b){for(var c=0;c<a.length;c++)if(a[c].fret==b)return a[c].finger;return 0};this.getPrimaryFrets=function(b){a=b-1;b=f();for(var c=[],d=0;d<b.length;d++){var e=l(b[d].dots);c.push(n(e.max))}return c};this.getDefinition=function(b,c){var d=(b=m(b))&&0<b.length?b:"CHORDNAME",e="",g="",q="";a=c-1;for(var s=f(),v=0;v<s.length;v++){var w=l(s[v].dots),e=e+(n(w.max)+" "),g=g+(r(s[v].dots,w.max)+" ");w.max!=w.min&&(q+=" add: string "+
s[v].string+" fret "+n(w.min)+" finger "+r(s[v].dots,w.min))}return("{define: "+d+" frets "+e+" fingers "+g+q+"}").replace(/\s+/g," ").replace(" }","}")};this.getDefinitionHtml=function(b,a){b=m(b);var c=this.getDefinition(b,a),c=c.replace(" "+b," X07Myq791wso01"),c=c.replace(/\b(\d+)\b/g,'<span class="chordPro-X07MX001number">$1</span>'),c=c.replace(/\b(frets?|fingers?|string)\b/g,'<span class="chordPro-X07MX001attribute">$1</span>'),c=c.replace(/\b(define|add)\b/g,'<span class="chordPro-X07MX001keyword">$1</span>');
return c.replace("X07Myq791wso01",'<span class="chordPro-string">'+b+"</span>").replace(/X07MX001/g,"").replace(/ +/g," ")};var m=function(b){b=b.replace(/^\s*(.*?)\s*$/,"$1").replace(/\s+/g,"-");/^(frets|fingers|add:)$/i.test(b)&&(b="");return b.substring(0,c.nameMaxLength)}};
ugsChordBuilder.chooserList=new function(){var b=[],c=null,a=0,g=null,f=function(){},l=this,n=null,r={showText:!1,height:50,width:40,fretSpace:9,stringSpace:7,dotRadius:3,lineWidth:1,topLeftPos:{x:10,y:2},xWidth:0.7*7,xStroke:1.4},m={dot:"8pt Arial",text:"8pt Arial",fret:"8pt Arial"},k={fretLines:"#EED18E",dots:"#551D00",dotText:"#ffffff",text:"#000000",fretText:"#EED18E",xStroke:"#551D00"},h=function(b,c){this.id=a++;this.name=b;this.definition=c};this.init=function(b){f=b;c=document.getElementById("cdBldPick");
c.addEventListener("click",e,!1);d()};var d=function(){for(var a=/\{define:\s*([^}]+?)\s+frets[^}]+?\}/im,d=document.getElementById("chordProSource").value.split("\n"),g=d.length-1;0<=g;g--)a.test(d[g])&&A(d[g].replace(a,"$1"),d[g]);for(var d=c,g=b,e="",a=0;a<g.length;a++)e+=q(g[a].id,g[a].name);d.innerHTML='<li data-id="-1" class="newChord">+ Add New Chord</li>'+e;d=d.getElementsByTagName("li");for(a=d.length-1;0<=a;a--)1>a||s(d[a].getAttribute("data-id"))};this.reset=function(){b=[];document.getElementById("cdBldPick").innerHTML=
"";a=0;g=null;d()};this.show=function(b){document.getElementById("cdBldChooserPanel").style.display=b?"block":"none";document.getElementById("cdBldBuilderPanel").style.display=b?"none":"block";$("#cdBldChooserPanel").closest(".overlay").toggleClass("chordBuilderNarrow",b)};this.save=function(a){var d;a:{d=null==g?-1:g.id;for(var e=a.name.toLowerCase(),f=b.length-1;0<=f;f--)if(""+b[f].id!=""+d&&b[f].name.toLowerCase()==e){d=f;break a}d=-1}if(0<=d)return alert("Hey, this chord name is already being used."),
!1;d=-1;if(null==g){d=A(a.name,a.definition);g=y(d);a=a.definition;for(var e=document.getElementById("chordProSource"),f=/\s*\{\s*(title|t|artist|subtitle|st|album|define):.*?\}/im,k=e.value.split("\n"),h="",l=!1,m=k.length-1;0<=m;m--)!l&&f.test(k[m])&&(h=a+"\n"+h,l=!0),h=k[m]+"\n"+h;e.value=h;ugsEditorPlus.actions.run()}else{e=z(g.id);if(0>e)return!1;f=b[e].definition;b[e].name=a.name;b[e].definition=a.definition;d=b[e].id;w(f,b[e].definition)}a=y(d);(e=p(d))?e.innerHTML=q(d,a.name,!0):(a=a.name,
e=document.createElement("ul"),e.innerHTML=q(d,a),c.appendChild(e.childNodes[0]));s(d);this.show(!0);return!0};var e=function(a){a.preventDefault();g=y(a.target.getAttribute("data-id"));if("delete"==a.target.getAttribute("data-action")){if(a=g,confirm('Delete definition for "'+a.name+'"?')){var b=p(a.id);b&&(c.removeChild(b),w(a.definition,""))}}else{a=null;if(null!=g){a=ukeGeeks.chordImport.runLine(g.definition);a:{if(a.muted)for(b=0;b<a.muted.length;b++)if(a.muted[b]){b=!0;break a}b=!1}b&&alert("Uh-oh! This chord uses muted strings!\nCurrently the Chord Builder does not support muted strings -- \nsaving edits will result in mutes being lost.")}f(a);
l.show(!1)}},p=function(a){for(var b=c.getElementsByTagName("li"),d=0;d<b.length;d++)if(b[d].getAttribute("data-id")==""+a)return b[d];return null},q=function(a,b,c){c=2<arguments.length?c:!1;var d='<span class="deleteChord" data-id="'+a+'" data-action="delete" title="Remove this definition"></span>'+b;return c?d:'<li data-id="'+a+'" title="Edit this definition" class="ugs-grouped">'+d+"</li>"},s=function(a){var b=p(a);a=y(a);a=ukeGeeks.chordImport.runLine(a.definition);null==n&&(n=new ukeGeeks.chordBrush);
n.plot(b,a,r,m,k)},v=function(a,b,c){var d=a.replace(b,c);return d==a?a:v(d,b,c)},w=function(a,b){var c=document.getElementById("chordProSource");c.value=v(c.value,a,b);ugsEditorPlus.actions.run()},z=function(a){for(var c=0;c<b.length;c++)if(""+b[c].id==a)return c;return-1},y=function(a){a=z(a);return 0<=a?b[a]:null},A=function(a,c){var d=new h(a,c);b.push(d);return d.id}};
ugsChordBuilder.editorUi=function(){var b=null,c=null,a=null,g=1,f="",l=!0,n=0,r={0:"None",1:"Index finger",2:"Middle finger",3:"Ring finger",4:"Pinkie"};this.init=function(){b=document.getElementById("cdBldCursorCanvas");if(!b.getContext)return!1;for(var g=b.getContext("2d"),f=document.getElementById("cdBldDiagramCanvas").getContext("2d"),p=document.getElementById("cdBldStartingFret"),l="",n=ugsChordBuilder.settings.fretBoard.maxFret-ugsChordBuilder.settings.fretBoard.numFrets+1,s=1;s<=n;s++)l+=
'<option value="'+s+'">'+s+"</option>";p.innerHTML=l;p.addEventListener("change",w,!1);document.getElementById("cdBldChordName").addEventListener("keyup",v,!1);c=document.getElementById("cdBldDotsBtn");a=document.getElementById("cdBldFingersBtn");c.addEventListener("click",q,!1);a.addEventListener("click",q,!1);document.getElementById("cdBldShowOutputBtn").addEventListener("click",k,!1);document.getElementById("cdBldCancelBtn").addEventListener("click",h,!1);document.getElementById("cdBldSaveBtn").addEventListener("click",
d,!1);document.getElementById("toolboxSlideUpBtn").addEventListener("click",z,!1);document.getElementById("toolboxSlideDownBtn").addEventListener("click",z,!1);m();document.getElementById("cdBldEditorSurface").addEventListener("mousemove",y,!1);b.addEventListener("click",A,!1);ugsChordBuilder.chordCanvas.init(f,b);ugsChordBuilder.cursorCanvas.init(g);x();t();ugsChordBuilder.chooserList.init(e);return!0};var m=function(){n++;4<n&&(n=0);document.getElementById("cdBldBtnFingerName").innerHTML=r[n]+" ("+
n+")";document.getElementById("cdBldBtnDiagram").className="fingerToolImage finger"+n},k=function(a){s(document.getElementById("cdBldOutputBox"),"collapseOutput",!a.target.checked)},h=function(a){a.preventDefault();p();ugsChordBuilder.chooserList.show(!0)},d=function(a){a.preventDefault();a={name:f,startingFret:g,dots:ugsChordBuilder.fretDots.getDots(),definition:ugsChordBuilder["export"].getDefinition(f,g)};ugsChordBuilder.chooserList.save(a)||(a=document.getElementById("cdBldChordName"),a.focus(),
a.select())},e=function(a){if(null==a)p();else{var b;b=a.dots;for(var c=0,d=0;d<b.length;d++)b[d].fret>c&&(c=b[d].fret);b=c;b=b>ugsChordBuilder.settings.fretBoard.numFrets?b-ugsChordBuilder.settings.fretBoard.numFrets+1:1;c=p;d=a.name;a=a.dots;for(var e=b-1,g=[],f=0;f<a.length;f++){var k=a[f].fret-e;g.push(new ugsChordBuilder.entities.Dot(a[f].string,0>k?0:k,a[f].finger))}c(d,b,g,!1)}},p=function(b,d,e,k){k=3<arguments.length?k:!0;ugsChordBuilder.fretDots.reset();var h=k;f=b&&0<b.length?b:"CHORDNAME";
document.getElementById("cdBldChordName").value=f;g=d?d:1;document.getElementById("cdBldStartingFret").value=g;document.getElementById("cdBldShowOutputBtn").checked=!1;s(document.getElementById("cdBldOutputBox"),"collapseOutput",!0);document.getElementById("cdBldSaveBtn").value=h?"Add":"Update";l=!0;n=0;m();s(c,"selected",l);s(a,"selected",!l);s(document.getElementById("cdBldToolbox"),"open",!l);ugsChordBuilder.cursorCanvas.setCursor(l,n);if(e&&0<e.length)for(h=0;h<e.length;h++)ugsChordBuilder.fretDots.toggleDot(e[h]);
x();t()},q=function(b){b.preventDefault();b=0<=b.currentTarget.href.indexOf("#dots");b==l?b||(m(),ugsChordBuilder.cursorCanvas.setCursor(l,n)):(s(c,"selected",b),s(a,"selected",!b),s(document.getElementById("cdBldToolbox"),"open",!b),l=b,ugsChordBuilder.cursorCanvas.setCursor(l,n))},s=function(a,b,c){var d=0<=a.className.indexOf(b);c&&!d?a.className+=" "+b:!c&&d&&(a.className=a.className.replace(b,"").replace(/\s+/g," "))},v=function(a){f=this.value;t()},w=function(a){g=parseInt(this.value,10);t();
x()},z=function(a){a.preventDefault();var b=!1;a="up"==a.target.getAttribute("data-direction")?-1:1;if(ugsChordBuilder.fretDots.slide(a))b=!0;else{a=g+a;var c=ugsChordBuilder.settings.fretBoard.maxFret-ugsChordBuilder.settings.fretBoard.numFrets+1;1<=a&&a<=c&&(g=a,document.getElementById("cdBldStartingFret").value=a,b=!0)}b&&(x(),t())},y=function(a){ugsChordBuilder.cursorCanvas.draw(u(this,a))},A=function(a){a=u(b,a);var c=ugsChordBuilder.tracking.toDot(a);c&&(l?(ugsChordBuilder.fretDots.toggleDot(c),
x(a),t()):ugsChordBuilder.fretDots.toggleFinger(c,n)&&(x(a),t()))},u=function(a,b){var c=a.getBoundingClientRect();return new ugsChordBuilder.entities.Position(b.clientX-c.left,b.clientY-c.top)},x=function(a){a=a||new ugsChordBuilder.entities.Position(0,0);ugsChordBuilder.chordCanvas.draw(a,g)},t=function(){document.getElementById("cdBldOutput").innerHTML=ugsChordBuilder["export"].getDefinitionHtml(f,g)};this.reload=function(){p();ugsChordBuilder.chooserList.reset();ugsChordBuilder.chooserList.show(!0)}};
LazyLoad=function(b){function c(a,c){var d=b.createElement(a),e;for(e in c)c.hasOwnProperty(e)&&d.setAttribute(e,c[e]);return d}function a(a){var b=k[a],c,e;b&&(c=b.callback,e=b.urls,e.shift(),h=0,e.length||(c&&c.call(b.context,b.obj),k[a]=null,d[a].length&&f(a)))}function g(){var a=navigator.userAgent;r={async:!0===b.createElement("script").async};(r.webkit=/AppleWebKit\//.test(a))||(r.ie=/MSIE|Trident/.test(a))||(r.opera=/Opera/.test(a))||(r.gecko=/Gecko\//.test(a))||(r.unknown=!0)}function f(e,
f,h,v,w){var z=function(){a(e)},y="css"===e,A=[],u,x,t,B;r||g();if(f)if(f="string"===typeof f?[f]:f.concat(),y||r.async||r.gecko||r.opera)d[e].push({urls:f,callback:h,obj:v,context:w});else for(u=0,x=f.length;u<x;++u)d[e].push({urls:[f[u]],callback:u===x-1?h:null,obj:v,context:w});if(!k[e]&&(B=k[e]=d[e].shift())){m||(m=b.head||b.getElementsByTagName("head")[0]);f=B.urls.concat();u=0;for(x=f.length;u<x;++u)h=f[u],y?t=r.gecko?c("style"):c("link",{href:h,rel:"stylesheet"}):(t=c("script",{src:h}),t.async=
!1),t.className="lazyload",t.setAttribute("charset","utf-8"),r.ie&&!y&&"onreadystatechange"in t&&!("draggable"in t)?t.onreadystatechange=function(){/loaded|complete/.test(t.readyState)&&(t.onreadystatechange=null,z())}:y&&(r.gecko||r.webkit)?r.webkit?(B.urls[u]=t.href,n()):(t.innerHTML='@import "'+h+'";',l(t)):t.onload=t.onerror=z,A.push(t);u=0;for(x=A.length;u<x;++u)m.appendChild(A[u])}}function l(b){var c;try{c=!!b.sheet.cssRules}catch(d){h+=1;200>h?setTimeout(function(){l(b)},50):c&&a("css");return}a("css")}
function n(){var b=k.css,c;if(b){for(c=e.length;0<=--c;)if(e[c].href===b.urls[0]){a("css");break}h+=1;b&&(200>h?setTimeout(n,50):a("css"))}}var r,m,k={},h=0,d={css:[],js:[]},e=b.styleSheets;return{css:function(a,b,c,d){f("css",a,b,c,d)},js:function(a,b,c,d){f("js",a,b,c,d)}}}(this.document);